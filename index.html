<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Volt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js "></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .kanban-scroll::-webkit-scrollbar { height: 8px; }
        .kanban-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .kanban-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .sortable-ghost { opacity: 0.4; background: #e2e8f0; border: 2px dashed #94a3b8; }
        .sortable-drag { cursor: grabbing; transform: rotate(2deg); }
        .widget { transition: all 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .page-transition { animation: fadeIn 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loading-skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @media (max-width: 768px) {
            .kanban-container { flex-direction: column; }
            .kanban-column { width: 100% !important; margin-bottom: 1rem; }
            /* Reports Page Fixes */
        .report-content {
    min-height: 0; /* Prevent expansion */
}

        .chart-container {
    position: relative;
    height: 250px;
    width: 100%;
}

/* Prevent canvas from expanding */
canvas {
    max-height: 250px !important;
    width: 100% !important;
}

/* Ensure tables don't cause overflow */
        .report-content table {
    table-layout: fixed;
}

/* Hide overflow on report containers */
#report-content-financial,
#report-content-projects,
#report-content-productivity {
    overflow: hidden;
}
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">
    <!-- Loading Overlay -->
    <div id="global-loading" class="hidden fixed inset-0 bg-white/80 z-50 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600 mb-2"></i>
            <p class="text-slate-600">Loading...</p>
        </div>
    </div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-xl mb-4">
                    <i class="fas fa-bolt text-3xl text-blue-600"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-900">Work Volt</h1>
                <p class="text-slate-500 mt-2">Power your operations</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div id="login-error" class="hidden text-red-600 text-sm bg-red-50 p-2 rounded"></div>
                <button type="submit" id="login-btn" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                    <span id="login-btn-text">Sign In</span>
                    <i id="login-btn-spinner" class="fas fa-spinner fa-spin hidden"></i>
                </button>
            </form>
        </div>
    </div>

    <div id="app-screen" class="hidden min-h-screen flex flex-col">
        <header class="bg-white border-b border-slate-200 sticky top-0 z-40">
            <div class="flex items-center justify-between px-4 py-3">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 hover:bg-slate-100 rounded-lg"><i class="fas fa-bars text-slate-600"></i></button>
                    <div class="flex items-center gap-2 cursor-pointer" onclick="showModule('dashboard')">
                        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center"><i class="fas fa-bolt text-white text-sm"></i></div>
                        <span class="text-xl font-bold text-slate-900">Work Volt</span>
                    </div>
                </div>
                <div class="flex-1 max-w-xl mx-4 hidden md:block">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" placeholder="Search..." class="w-full pl-10 pr-4 py-2 bg-slate-100 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div class="flex items-center gap-3">
    <div class="relative">
        <button onclick="toggleNotificationDropdown()" class="relative p-2 hover:bg-slate-100 rounded-lg transition-colors">
            <i class="fas fa-bell text-slate-600 text-lg"></i>
            <span id="notif-badge" class="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center hidden">0</span>
        </button>
        
        <!-- Notification Dropdown -->
        <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-96 bg-white rounded-xl shadow-2xl border border-slate-200 z-50 overflow-hidden">
            <div class="p-4 border-b border-slate-200 flex items-center justify-between bg-slate-50">
                <h3 class="font-semibold text-slate-900">Notifications</h3>
                <div class="flex gap-2">
                    <button onclick="markAllNotificationsRead()" class="text-xs text-blue-600 hover:text-blue-800 font-medium">Mark all read</button>
                    <button onclick="toggleNotificationDropdown()" class="text-slate-400 hover:text-slate-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="notification-list" class="max-h-96 overflow-y-auto">
                <div class="p-8 text-center text-slate-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p class="text-sm">Loading notifications...</p>
                </div>
            </div>
            <div class="p-3 border-t border-slate-200 bg-slate-50 text-center">
                <button onclick="showModule('notifications'); toggleNotificationDropdown();" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                    View All Notifications
                </button>
            </div>
        </div>
    </div>
    
    <div class="flex items-center gap-2 pl-3 border-l border-slate-200">
        <div id="user-avatar" class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-medium text-sm">JD</div>
        <span id="user-name" class="hidden md:block text-sm font-medium text-slate-700">John Doe</span>
        <button onclick="logout()" class="ml-2 p-2 hover:bg-slate-100 rounded-lg text-slate-500" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
    </div>
</div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <aside id="sidebar" class="w-64 bg-white border-r border-slate-200 flex-shrink-0 hidden lg:flex flex-col">
                <nav class="flex-1 overflow-y-auto p-4 space-y-1" id="nav-menu"></nav>
            </aside>
            <main class="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-6" id="main-content"></main>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwY-oCLRpuxl8ghe-avGACVid5F2WPqE01V1P5s42QJFjl0U6RA2WBJ1M6SNWMOkOMz/exec';
        let currentUser = null;
        let currentToken = localStorage.getItem('workvolt_token');
        let dashboardSortable = null;
        let allUsers = [];
        let cache = {
            tasks: null,
            users: null,
            payroll: null,
            timesheets: null,
            lastFetch: {}
        };

        // Cache helper
        function getCached(key, maxAge = 30000) {
            const cached = cache[key];
            const lastFetch = cache.lastFetch[key];
            if (cached && lastFetch && (Date.now() - lastFetch) < maxAge) {
                return cached;
            }
            return null;
        }

        function setCached(key, data) {
            cache[key] = data;
            cache.lastFetch[key] = Date.now();
        }

        function clearCache() {
            cache = { tasks: null, users: null, payroll: null, timesheets: null, lastFetch: {} };
        }

        async function apiCall(path, params = {}, retries = 2) {
            const url = new URL(API_URL);
            url.searchParams.append('path', path);
            if(currentToken) url.searchParams.append('token', currentToken);
            for(let key in params) {
                if(params[key] !== undefined && params[key] !== null) url.searchParams.append(key, params[key]);
            }
            
            let lastError;
            for(let i = 0; i <= retries; i++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    
                    const response = await fetch(url.toString(), {
                        method: 'GET', 
                        mode: 'cors', 
                        cache: 'no-cache',
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if(!response.ok) throw new Error('HTTP ' + response.status);
                    const text = await response.text();
                    if(!text || text.trim() === '') throw new Error('Empty response');
                    
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch(e) {
                        throw new Error('Invalid JSON: ' + text.substring(0, 100));
                    }
                    
                    if(data.error) throw new Error(data.error);
                    return data;
                } catch(err) {
                    lastError = err;
                    if(err.name === 'AbortError') {
                        lastError = new Error('Request timeout - please try again');
                    }
                    if(err.message === 'Unauthorized' || err.message === 'TOKEN_INVALID') {
                        localStorage.removeItem('workvolt_token');
                        localStorage.removeItem('workvolt_user');
                        currentToken = null;
                        currentUser = null;
                        document.getElementById('app-screen').classList.add('hidden');
                        document.getElementById('login-screen').classList.remove('hidden');
                        showToast('Session expired. Please log in again.', 'error');
                        throw new Error('Session expired');
                    }
                    if(i < retries) await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
            throw lastError || new Error('Network error - please refresh');
        }

        // Login with timeout protection
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            const btnText = document.getElementById('login-btn-text');
            const btnSpinner = document.getElementById('login-btn-spinner');
            const errorDiv = document.getElementById('login-error');
            
            btn.disabled = true;
            btnText.classList.add('hidden');
            btnSpinner.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            
            const timeoutId = setTimeout(() => {
                btn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
                errorDiv.textContent = 'Login timed out. Please try again.';
                errorDiv.classList.remove('hidden');
            }, 15000);
            
            try {
                const data = await apiCall('auth/login', {email, password}, 1);
                clearTimeout(timeoutId);
                
                currentToken = data.token;
                currentUser = data.user;
                localStorage.setItem('workvolt_token', currentToken);
                localStorage.setItem('workvolt_user', JSON.stringify(currentUser));
                
                btn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
                
                showApp();
            } catch(err) {
                clearTimeout(timeoutId);
                btn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
                errorDiv.textContent = err.message || 'Login failed. Please try again.';
                errorDiv.classList.remove('hidden');
            }
        });

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-avatar').textContent = currentUser.name.split(' ').map(n => n[0]).join('').slice(0,2);
            renderNav();
            
            const lastModule = sessionStorage.getItem('lastModule') || 'dashboard';
            showModule(lastModule);
            startNotificationPolling();
        }
        
        function logout() {
    stopNotificationPolling();
    clearCache();
    localStorage.removeItem('workvolt_token');
    localStorage.removeItem('workvolt_user');
    sessionStorage.removeItem('lastModule');
    currentToken = null;
    currentUser = null;
    document.getElementById('app-screen').classList.add('hidden');
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('login-email').value = '';
    document.getElementById('login-password').value = '';
    }

        const modules = {
            SuperAdmin: ['dashboard', 'tasks', 'pipeline', 'payroll', 'timesheets', 'financials', 'crm', 'projects', 'workflows', 'reports', 'email-settings'],
            Admin: ['dashboard', 'tasks', 'pipeline', 'payroll', 'timesheets', 'financials', 'crm', 'projects', 'workflows', 'reports', 'email-settings'],
            Manager: ['dashboard', 'tasks', 'pipeline', 'payroll', 'timesheets', 'financials', 'crm', 'projects', 'reports'],
            Employee: ['dashboard', 'tasks', 'payroll', 'timesheets'],
            Contractor: ['dashboard', 'tasks', 'payroll', 'timesheets']
        };

        const moduleIcons = {
            dashboard: 'fa-th-large', 
            tasks: 'fa-check-circle', 
            pipeline: 'fa-users', 
            payroll: 'fa-money-bill-wave', 
            timesheets: 'fa-clock',
            financials: 'fa-chart-line',
            crm: 'fa-address-book',
            projects: 'fa-folder-open',
            workflows: 'fa-robot',
            reports: 'fa-chart-pie',
            'email-settings': 'fa-envelope-cog'
            
        };

        function renderNav() {
            const nav = document.getElementById('nav-menu');
            const allowed = modules[currentUser.role] || modules.Employee;
            nav.innerHTML = allowed.map(mod => `
                <a href="#" onclick="showModule('${mod}'); return false;" class="nav-item flex items-center gap-3 px-3 py-2 text-slate-600 hover:bg-slate-50 rounded-lg font-medium transition-colors" data-module="${mod}">
                    <i class="fas ${moduleIcons[mod]} w-5"></i> ${mod.charAt(0).toUpperCase() + mod.slice(1)}
                </a>
            `).join('');
        }

            function showModule(moduleName) {
    // Close sidebar on mobile when selecting a page
    if (window.innerWidth < 1024) {
        document.getElementById('sidebar').classList.add('hidden');
    }
    
    sessionStorage.setItem('lastModule', moduleName);
    
    document.querySelectorAll('.nav-item').forEach(n => {
        n.classList.remove('bg-blue-50', 'text-blue-700');
        n.classList.add('text-slate-600');
    });
    const navItem = document.querySelector(`[data-module="${moduleName}"]`);
    if(navItem) {
        navItem.classList.add('bg-blue-50', 'text-blue-700');
        navItem.classList.remove('text-slate-600');
    }
    
    const main = document.getElementById('main-content');
    main.innerHTML = '<div class="flex items-center justify-center h-64"><i class="fas fa-circle-notch fa-spin text-3xl text-blue-600"></i></div>';
    
    setTimeout(() => {
        switch(moduleName) {
            case 'dashboard': loadDashboard(main); break;
            case 'tasks': 
                const preselectedProject = sessionStorage.getItem('preselectedProjectId');
                loadTasks(main, preselectedProject);
                if (preselectedProject) {
                    sessionStorage.removeItem('preselectedProjectId');
                }
                break;
            case 'pipeline': loadPipeline(main); break;
            case 'payroll': loadPayroll(main); break;
            case 'timesheets': loadTimesheets(main); break;
            case 'financials': loadFinancials(main); break;
            case 'crm': loadCRM(main); break;
            case 'projects': loadProjects(main); break;
            case 'workflows': loadWorkflows(main); break; // Add this when ready
            case 'reports': loadReports(main); break;
            case 'email-settings': loadEmailSettings(main); break;
            default: main.innerHTML = '<div class="text-center py-20 text-slate-400">Module coming soon</div>';
        }
    }, 50);
}

        async function loadDashboard(container) {
            container.innerHTML = `
                <div class="page-transition">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Dashboard</h2>
                            <p class="text-slate-500">Welcome back, ${currentUser.name}</p>
                        </div>
                        <button onclick="toggleEditMode()" id="edit-btn" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50">
                            <i class="fas fa-pen mr-2"></i>Customize
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="dashboard-grid">
                        ${renderWidget('my-tasks', 'My Tasks', 'col-span-1 row-span-2')}
                        ${renderWidget('stats', 'Quick Stats', '')}
                        ${renderWidget('pipeline', 'Hiring', '')}
                    </div>
                </div>
            `;
            
            dashboardSortable = new Sortable(document.getElementById('dashboard-grid'), {
                animation: 150, handle: '.widget-handle', ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', disabled: true, onEnd: saveDashboardLayout
            });
            
            await loadAllWidgetData();
        }

        function renderWidget(type, title, classes) {
            return `
                <div class="widget bg-white rounded-xl shadow-sm border border-slate-200 p-4 ${classes}" data-widget="${type}">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-slate-900">${title}</h3>
                        <i class="fas fa-grip-vertical text-slate-400 widget-handle hidden cursor-move"></i>
                    </div>
                    <div class="widget-content" id="widget-${type}">
                        <div class="animate-pulse space-y-3">
                            <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                            <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadAllWidgetData() {
            try {
                let tasks = getCached('tasks');
                if (!tasks) {
                    const tasksData = await apiCall('tasks', {assignee: currentUser.user_id});
                    tasks = tasksData.tasks || [];
                    setCached('tasks', tasks);
                }
                
                const myTasksHtml = tasks.filter(t => t.status !== 'Done').slice(0, 5).map(t => `
                    <div class="flex items-start gap-3 p-3 bg-slate-50 rounded-lg border-l-4 ${getPriorityColor(t.priority)} mb-2 cursor-pointer hover:bg-slate-100" onclick="showModule('tasks')">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-slate-900 line-clamp-1">${t.title}</p>
                            <p class="text-xs text-slate-500 mt-1">${t.due_date || 'No due date'} ${t.actual_hours > 0 ? `• ${t.actual_hours}h logged` : ''}</p>
                        </div>
                    </div>
                `).join('') || '<p class="text-sm text-slate-400">No pending tasks</p>';
                document.getElementById('widget-my-tasks').innerHTML = myTasksHtml;

                const todoCount = tasks.filter(t => t.status === 'Todo').length;
                const inProgressCount = tasks.filter(t => t.status === 'In Progress').length;
                const doneCount = tasks.filter(t => t.status === 'Done').length;
                document.getElementById('widget-stats').innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-3 bg-blue-50 rounded-lg cursor-pointer hover:bg-blue-100" onclick="showModule('tasks')">
                            <p class="text-2xl font-bold text-blue-600">${tasks.length}</p>
                            <p class="text-xs text-blue-700 font-medium">Total Tasks</p>
                        </div>
                        <div class="text-center p-3 bg-amber-50 rounded-lg cursor-pointer hover:bg-amber-100" onclick="showModule('tasks')">
                            <p class="text-2xl font-bold text-amber-600">${inProgressCount}</p>
                            <p class="text-xs text-amber-700 font-medium">In Progress</p>
                        </div>
                        <div class="text-center p-3 bg-green-50 rounded-lg cursor-pointer hover:bg-green-100" onclick="showModule('tasks')">
                            <p class="text-2xl font-bold text-green-600">${doneCount}</p>
                            <p class="text-xs text-green-700 font-medium">Completed</p>
                        </div>
                        <div class="text-center p-3 bg-purple-50 rounded-lg cursor-pointer hover:bg-purple-100" onclick="showModule('tasks')">
                            <p class="text-2xl font-bold text-purple-600">${todoCount}</p>
                            <p class="text-xs text-purple-700 font-medium">To Do</p>
                        </div>
                    </div>
                `;
            } catch(e) {
                document.getElementById('widget-my-tasks').innerHTML = '<p class="text-sm text-slate-400">Unable to load tasks</p>';
                document.getElementById('widget-stats').innerHTML = '<p class="text-sm text-slate-400">Unable to load stats</p>';
            }
            
            try {
                const pipeData = await apiCall('pipeline');
                const candidates = pipeData.candidates || [];
                const stages = ['Applied', 'Screening', 'Interview', 'Offer', 'Hired'];
                const stageCounts = {};
                stages.forEach(s => stageCounts[s] = candidates.filter(c => c.stage === s).length);
                document.getElementById('widget-pipeline').innerHTML = `
                    <div class="flex gap-2 overflow-x-auto pb-2 cursor-pointer" onclick="showModule('pipeline')">
                        ${stages.map(stage => `
                            <div class="flex-shrink-0 w-20 p-3 ${stage === 'Hired' ? 'bg-green-50' : 'bg-slate-50'} rounded-lg text-center hover:bg-opacity-80">
                                <p class="text-xl font-bold ${stage === 'Hired' ? 'text-green-600' : 'text-slate-700'}">${stageCounts[stage]}</p>
                                <p class="text-xs ${stage === 'Hired' ? 'text-green-600' : 'text-slate-500'}">${stage}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch(e) {
                document.getElementById('widget-pipeline').innerHTML = '<p class="text-sm text-slate-400">Unable to load pipeline</p>';
            }
        }

        function toggleEditMode() {
            const btn = document.getElementById('edit-btn');
            const isEditing = btn.classList.contains('bg-blue-600');
            if(isEditing) {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-white', 'text-slate-700');
                btn.innerHTML = '<i class="fas fa-pen mr-2"></i>Customize';
                document.querySelectorAll('.widget-handle').forEach(h => h.classList.add('hidden'));
                dashboardSortable.option("disabled", true);
            } else {
                btn.classList.remove('bg-white', 'text-slate-700');
                btn.classList.add('bg-blue-600', 'text-white');
                btn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Layout';
                document.querySelectorAll('.widget-handle').forEach(h => h.classList.remove('hidden'));
                dashboardSortable.option("disabled", false);
            }
        }

        async function saveDashboardLayout() {
            const widgets = [];
            document.querySelectorAll('.widget').forEach((w, i) => widgets.push({type: w.dataset.widget, index: i}));
            try {
                await apiCall('users/dashboard', {layout: JSON.stringify(widgets)});
                showToast('Layout saved');
            } catch(e) {
                showToast(e.message || 'Save failed', 'error');
            }
        }

        function getPriorityColor(p) {
            return {Urgent: 'border-red-500', High: 'border-amber-500', Medium: 'border-blue-500', Low: 'border-slate-300'}[p] || 'border-slate-300';
        }

        async function loadTasks(container, preselectedProjectId = null) {
    container.innerHTML = `
        <div class="page-transition">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Tasks</h2>
                    <p class="text-slate-500" id="tasks-subtitle">Drag cards to change status</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="clearProjectFilter()" id="clear-filter-btn" class="hidden px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-300">
                        <i class="fas fa-times mr-2"></i>Clear Filter
                    </button>
                    <button onclick="openCreateTaskForm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>New Task
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4" id="tasks-filter-bar">
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-1">Project</label>
                        <select id="task-project-filter" onchange="applyTaskFilters()" class="px-3 py-2 border border-slate-300 rounded-lg text-sm min-w-[200px]">
                            <option value="">All Projects</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-1">Assignee</label>
                        <select id="task-assignee-filter" onchange="applyTaskFilters()" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                            <option value="">All Assignees</option>
                        </select>
                    </div>
                    <button onclick="applyTaskFilters()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200">
                        <i class="fas fa-filter mr-1"></i>Apply
                    </button>
                </div>
            </div>
            
            <div class="flex gap-6 overflow-x-auto kanban-scroll pb-4" id="task-board">
                ${renderKanbanColumn('Backlog', 'bg-slate-400')}
                ${renderKanbanColumn('Todo', 'bg-blue-400')}
                ${renderKanbanColumn('In Progress', 'bg-amber-400')}
                ${renderKanbanColumn('Review', 'bg-purple-400')}
                ${renderKanbanColumn('Done', 'bg-green-400')}
            </div>
        </div>
    `;
    
    await loadTaskFilterOptions();
    
    if (preselectedProjectId) {
        document.getElementById('task-project-filter').value = preselectedProjectId;
        document.getElementById('clear-filter-btn').classList.remove('hidden');
        updateTasksSubtitle(preselectedProjectId);
    }
    
    await applyTaskFilters();
}

// NEW: Proper Task Creation Form with Role-Based Assignment
async function openCreateTaskForm() {
    const isManagerOrAbove = currentUser.role === 'Manager' || currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
    
    // Load users for assignee dropdown if manager+
    let assigneeOptions = '';
    if (isManagerOrAbove) {
        try {
            let users = getCached('users');
            if (!users) {
                const userData = await apiCall('users');
                users = userData.users || [];
                setCached('users', users);
            }
            // Filter active users only
            assigneeOptions = users
                .filter(u => u.active !== false)
                .map(u => `<option value="${u.user_id}" ${u.user_id === currentUser.user_id ? 'selected' : ''}>${u.name} (${u.role})</option>`)
                .join('');
        } catch (e) {
            console.error('Failed to load users:', e);
        }
    }
    
    // Load projects for dropdown
    let projectOptions = '<option value="">No Project</option>';
    try {
        let projects = getCached('projects');
        if (!projects) {
            const projData = await apiCall('projects');
            projects = projData.projects || [];
            setCached('projects', projects);
        }
        projectOptions = projects.map(p => 
            `<option value="${p.project_id}">${p.name}</option>`
        ).join('') + '<option value="">No Project</option>';
    } catch (e) {
        console.error('Failed to load projects:', e);
    }
    
    const modal = document.createElement('div');
    modal.id = 'create-task-modal';
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-xl font-bold text-slate-900 mb-4">Create New Task</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Task Title <span class="text-red-500">*</span></label>
                        <input type="text" id="ct-title" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter task title..." autofocus>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                        <textarea id="ct-description" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Describe the task..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Project</label>
                            <select id="ct-project" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                ${projectOptions}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Priority</label>
                            <select id="ct-priority" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                                <option value="Urgent">Urgent</option>
                            </select>
                        </div>
                    </div>
                    
                    ${isManagerOrAbove ? `
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Assigned To</label>
                        <select id="ct-assignee" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            ${assigneeOptions}
                        </select>
                        <p class="text-xs text-slate-500 mt-1">As a manager, you can assign to any team member</p>
                    </div>
                    ` : `
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-1"></i>
                            This task will be assigned to <strong>you</strong> (${currentUser.name}). 
                            Managers can assign tasks to others.
                        </p>
                        <input type="hidden" id="ct-assignee" value="${currentUser.user_id}">
                    </div>
                    `}
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Due Date</label>
                            <input type="date" id="ct-due-date" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Est. Hours</label>
                            <input type="number" id="ct-estimated" step="0.5" min="0" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="0.0">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Pay Per Task ($)</label>
                            <input type="number" id="ct-pay" step="0.01" min="0" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="0.00">
                        </div>
                        <div class="flex items-center pt-6">
                            <input type="checkbox" id="ct-billable" class="w-4 h-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500">
                            <label for="ct-billable" class="ml-2 text-sm text-slate-700">Billable to client</label>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="submitCreateTask()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">
                        <i class="fas fa-check mr-2"></i>Create Task
                    </button>
                    <button onclick="closeCreateTaskModal()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('ct-title').focus();
}

function closeCreateTaskModal() {
    document.getElementById('create-task-modal')?.remove();
}

async function submitCreateTask() {
    const title = document.getElementById('ct-title').value.trim();
    const description = document.getElementById('ct-description').value.trim();
    const projectId = document.getElementById('ct-project').value;
    const priority = document.getElementById('ct-priority').value;
    const assigneeId = document.getElementById('ct-assignee').value;
    const dueDate = document.getElementById('ct-due-date').value;
    const estimated = document.getElementById('ct-estimated').value;
    const payPerTask = document.getElementById('ct-pay').value;
    const billable = document.getElementById('ct-billable').checked;
    
    if (!title) {
        showToast('Please enter a task title', 'error');
        document.getElementById('ct-title').focus();
        return;
    }
    
    try {
        await apiCall('tasks', {
            method: 'POST',
            title: title,
            description: description,
            project_id: projectId,
            priority: priority,
            assigned_to: assigneeId,
            due_date: dueDate,
            estimated_hours: estimated,
            pay_per_task: payPerTask,
            billable: billable,
            status: 'Backlog'
        });
        
        closeCreateTaskModal();
        clearCache();
        showToast('Task created successfully');
        applyTaskFilters();
    } catch (e) {
        showToast(e.message || 'Failed to create task', 'error');
    }
}

async function loadTaskFilterOptions() {
    const isManager = currentUser.role === 'Manager' || currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
    
    try {
        let projects = getCached('projects');
        if (!projects) {
            const projData = await apiCall('projects');
            projects = projData.projects || [];
            setCached('projects', projects);
        }
        
        const projectSelect = document.getElementById('task-project-filter');
        projects.forEach(p => {
            const option = document.createElement('option');
            option.value = p.project_id;
            option.textContent = p.name;
            projectSelect.appendChild(option);
        });
        
        if (isManager) {
            let users = getCached('users');
            if (!users) {
                const userData = await apiCall('users');
                users = userData.users || [];
                setCached('users', users);
            }
            
            const assigneeSelect = document.getElementById('task-assignee-filter');
            users.forEach(u => {
                if (u.active !== false) {
                    const option = document.createElement('option');
                    option.value = u.user_id;
                    option.textContent = u.name;
                    assigneeSelect.appendChild(option);
                }
            });
        } else {
            document.getElementById('task-assignee-filter').parentElement.style.display = 'none';
        }
    } catch (e) {
        console.error('Failed to load filter options:', e);
    }
}

async function applyTaskFilters() {
    const projectId = document.getElementById('task-project-filter').value;
    const assigneeId = document.getElementById('task-assignee-filter')?.value || '';
    
    try {
        let projects = getCached('projects');
        if (!projects) {
            const projData = await apiCall('projects');
            projects = projData.projects || [];
            setCached('projects', projects);
        }
        
        let params = {};
        if (assigneeId) params.assignee = assigneeId;
        
        let tasks = getCached('tasks');
        if (!tasks) {
            const data = await apiCall('tasks', params);
            tasks = data.tasks || [];
            setCached('tasks', tasks);
        }
        
        if (projectId) {
            tasks = tasks.filter(t => t.project_id == projectId);
        }
        
        ['Backlog', 'Todo', 'In-Progress', 'Review', 'Done'].forEach(status => {
            const col = document.getElementById(`col-${status}`);
            if(col) col.innerHTML = '';
        });
        
        tasks.forEach(task => {
            const col = document.getElementById(`col-${task.status.replace(' ', '-')}`);
            if(col) col.innerHTML += renderTaskCard(task, projects);
        });
        
        ['Backlog', 'Todo', 'In-Progress', 'Review', 'Done'].forEach(status => {
            const columnEl = document.getElementById(`col-${status}`);
            if (columnEl && !columnEl.classList.contains('sortable-initialized')) {
                columnEl.classList.add('sortable-initialized');
                new Sortable(columnEl, {
                    group: 'tasks', animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', delay: 100, delayOnTouchOnly: true,
                    onEnd: async function(evt) {
                        const taskId = evt.item.dataset.taskId;
                        const newStatus = evt.to.dataset.status;
                        const oldStatus = evt.from.dataset.status;
                        if(newStatus !== oldStatus) {
                            evt.item.style.opacity = '0.5';
                            try {
                                await apiCall('tasks/move', {task_id: taskId, to_status: newStatus});
                                evt.item.style.opacity = '1';
                                clearCache();
                                showToast(`Moved to ${newStatus}`);
                            } catch(e) {
                                evt.from.appendChild(evt.item);
                                evt.item.style.opacity = '1';
                                showToast(e.message || 'Failed to move', 'error');
                            }
                        }
                    }
                });
            }
        });
        
        const projectSelect = document.getElementById('task-project-filter');
        const projectName = projectId ? projectSelect.options[projectSelect.selectedIndex].text : 'All Projects';
        document.getElementById('tasks-subtitle').textContent = `${tasks.length} tasks • ${projectName}`;
        
    } catch(e) {
        console.error('Failed to load tasks:', e);
        document.getElementById('task-board').innerHTML += `<div class="text-red-500 mt-4">${e.message || 'Failed to load tasks'}</div>`;
    }
}

function updateTasksSubtitle(projectId) {
    const projectSelect = document.getElementById('task-project-filter');
    const projectName = projectSelect.options[projectSelect.selectedIndex].text;
    document.getElementById('tasks-subtitle').textContent = `Viewing tasks for: ${projectName}`;
}

function clearProjectFilter() {
    document.getElementById('task-project-filter').value = '';
    document.getElementById('clear-filter-btn').classList.add('hidden');
    applyTaskFilters();
}

        function renderKanbanColumn(status, colorClass) {
            const statusId = status.replace(' ', '-');
            return `
                <div class="flex-shrink-0 w-80">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-slate-700 flex items-center gap-2">
                            <span class="w-2 h-2 ${colorClass} rounded-full"></span>${status}
                        </h3>
                    </div>
                    <div class="space-y-3 min-h-[200px] bg-slate-100/50 rounded-xl p-2" id="col-${statusId}" data-status="${status}"></div>
                </div>
            `;
        }

        function renderTaskCard(task, projectsList = null) {
    const hoursDisplay = task.actual_hours > 0 ? 
        `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${task.actual_hours}h</span>` : '';
    
    const payDisplay = task.pay_per_task > 0 ? 
        `<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">$${task.pay_per_task}</span>` : '';
    
    let projectBadge = '';
    if (task.project_id) {
        const projects = projectsList || getCached('projects') || [];
        const project = projects.find(p => p.project_id == task.project_id);
        if (project) {
            projectBadge = `<span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full mr-1 truncate max-w-[100px]" title="${project.name}">${project.name}</span>`;
        } else {
            projectBadge = `<span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-full mr-1">#${task.project_id}</span>`;
        }
    }
    
    return `
        <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 card-hover cursor-move mb-2" data-task-id="${task.task_id}">
            <div class="flex items-start justify-between mb-2">
                <div class="flex flex-wrap gap-1 flex-1 min-w-0">
                    ${projectBadge}
                    <span class="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded">Task</span>
                </div>
                <span class="text-xs ${task.priority === 'Urgent' ? 'text-red-600 font-bold' : 'text-slate-400'} ml-2">${task.priority}</span>
            </div>
            <h4 class="font-medium text-slate-900 mb-2 text-sm line-clamp-2">${task.title}</h4>
            <div class="flex items-center justify-between text-xs text-slate-500 mb-2">
                <span>${task.due_date || 'No date'}</span>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex gap-1">
                    ${hoursDisplay}
                    ${payDisplay}
                </div>
                <button onclick="event.stopPropagation(); quickLogHours(${task.task_id})" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 transition-colors">
                    <i class="fas fa-clock mr-1"></i>Log
                </button>
            </div>
        </div>
    `;
}

        async function quickLogHours(taskId) {
            try {
                let tasks = getCached('tasks');
                if (!tasks) {
                    const tasksData = await apiCall('tasks', {assignee: currentUser.user_id});
                    tasks = tasksData.tasks || [];
                }
                
                const task = tasks.find(t => t.task_id == taskId);
                if (!task) {
                    showToast('Task not found', 'error');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.id = 'log-hours-modal';
                modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-slate-900 mb-1">Log Hours</h3>
                            <p class="text-sm text-slate-500 mb-4">${task.title}</p>
                            <div class="space-y-4">
                                <input type="hidden" id="lh-task" value="${taskId}">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
                                        <input type="date" id="lh-date" value="${getTodayDate()}" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Hours</label>
                                        <input type="number" id="lh-hours" step="0.25" min="0.25" max="24" placeholder="0.00" class="w-full px-3 py-2 border border-slate-300 rounded-lg" autofocus>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Notes (Optional)</label>
                                    <textarea id="lh-notes" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="What did you work on?"></textarea>
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="submitLogHours()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">Log Hours</button>
                                <button onclick="closeLogHoursModal()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('lh-hours').focus();
            } catch (e) {
                showToast('Failed to load task details', 'error');
            }
        }

        function closeLogHoursModal() {
            document.getElementById('log-hours-modal')?.remove();
        }

        async function submitLogHours() {
            const taskId = document.getElementById('lh-task').value;
            const date = document.getElementById('lh-date').value;
            const hours = parseFloat(document.getElementById('lh-hours').value);
            const notes = document.getElementById('lh-notes').value;
            
            if (!taskId) {
                showToast('Please select a task', 'error');
                return;
            }
            if (!hours || hours <= 0) {
                showToast('Please enter valid hours', 'error');
                return;
            }
            
            try {
                await apiCall('timesheets', {
                    method: 'POST',
                    task_id: taskId,
                    date: date,
                    hours: hours,
                    notes: notes
                }, 0);
                
                closeLogHoursModal();
                clearCache();
                showToast(`Logged ${hours} hours successfully`);
                
                const currentModule = sessionStorage.getItem('lastModule');
                if (currentModule === 'tasks') {
                    loadTasks(document.getElementById('main-content'));
                } else if (currentModule === 'timesheets') {
                    loadTimesheets(document.getElementById('main-content'));
                } else if (currentModule === 'dashboard') {
                    loadDashboard(document.getElementById('main-content'));
                }
            } catch (e) {
                showToast(e.message || 'Failed to log hours', 'error');
            }
        }

        async function loadPipeline(container) {
            container.innerHTML = `
                <div class="page-transition">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Hiring Pipeline</h2>
                            <p class="text-slate-500">Drag to move, drop on Hired to convert</p>
                        </div>
                        <button onclick="createCandidate()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Add Candidate
                        </button>
                    </div>
                    <div class="flex gap-6 overflow-x-auto kanban-scroll pb-4" id="pipeline-board">
                        ${renderPipelineColumn('Applied')}
                        ${renderPipelineColumn('Screening')}
                        ${renderPipelineColumn('Interview')}
                        ${renderPipelineColumn('Offer')}
                        ${renderPipelineColumn('Hired', true)}
                    </div>
                </div>
            `;
            
            try {
                const data = await apiCall('pipeline');
                const candidates = data.candidates || [];
                
                ['Applied', 'Screening', 'Interview', 'Offer', 'Hired'].forEach(stage => {
                    const col = document.getElementById(`pipe-${stage}`);
                    if(col) col.innerHTML = '';
                });
                
                candidates.forEach(c => {
                    const col = document.getElementById(`pipe-${c.stage}`);
                    if(col) col.innerHTML += renderCandidateCard(c);
                });
                
                ['Applied', 'Screening', 'Interview', 'Offer', 'Hired'].forEach(stage => {
                    new Sortable(document.getElementById(`pipe-${stage}`), {
                        group: 'pipeline', animation: 150, delay: 100, delayOnTouchOnly: true,
                        onEnd: async function(evt) {
                            const candidateId = evt.item.dataset.candidateId;
                            const newStage = evt.to.dataset.stage;
                            if(newStage === 'Hired' && !confirm('Hire this candidate? Creates employee record.')) {
                                evt.from.appendChild(evt.item);
                                return;
                            }
                            try {
                                const endpoint = newStage === 'Hired' ? 'pipeline/hire' : 'pipeline/move';
                                await apiCall(endpoint, {candidate_id: candidateId, to_stage: newStage});
                                showToast(newStage === 'Hired' ? 'Hired! Employee created.' : `Moved to ${newStage}`);
                                if(newStage === 'Hired') {
                                    evt.item.classList.add('bg-green-50', 'border-green-200');
                                    evt.item.innerHTML += '<div class="mt-2 text-xs text-green-600 font-medium">✓ Employee record created</div>';
                                }
                            } catch(e) {
                                evt.from.appendChild(evt.item);
                                showToast(e.message || 'Failed to move', 'error');
                            }
                        }
                    });
                });
            } catch(e) {
                container.innerHTML += `<div class="text-red-500 mt-4">${e.message || 'Failed to load pipeline'}</div>`;
            }
        }

        function renderPipelineColumn(stage, isFinal) {
            return `
                <div class="flex-shrink-0 w-80">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold ${isFinal ? 'text-green-700' : 'text-slate-700'}">${stage}</h3>
                    </div>
                    <div class="space-y-3 min-h-[200px] ${isFinal ? 'bg-green-50/50' : 'bg-slate-100/50'} rounded-xl p-2" id="pipe-${stage}" data-stage="${stage}"></div>
                </div>
            `;
        }

        function renderCandidateCard(c) {
            const isHired = c.stage === 'Hired';
            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border ${isHired ? 'border-green-200 bg-green-50' : 'border-slate-200'} card-hover cursor-move mb-2" data-candidate-id="${c.candidate_id}">
                    <div class="flex items-start justify-between mb-2">
                        <div class="w-10 h-10 ${isHired ? 'bg-green-500 text-white' : 'bg-blue-100 text-blue-600'} rounded-full flex items-center justify-center font-bold text-sm">
                            ${c.name.split(' ').map(n => n[0]).join('')}
                        </div>
                        ${c.rating ? `<span class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full">★ ${c.rating}</span>` : ''}
                    </div>
                    <h4 class="font-medium text-slate-900">${c.name}</h4>
                    <p class="text-sm text-slate-500 mb-1">${c.position || 'No position'}</p>
                    ${isHired ? '<div class="text-xs text-green-600 font-medium">✓ Converted to employee</div>' : ''}
                </div>
            `;
        }

        async function createCandidate() {
            const name = prompt('Candidate name:');
            if(!name) return;
            const email = prompt('Email:');
            if(!email) return;
            const position = prompt('Position:') || '';
            try {
                await apiCall('pipeline', {method: 'POST', name: name, email: email, position: position});
                showToast('Candidate added');
                loadPipeline(document.getElementById('main-content'));
            } catch(e) {
                showToast(e.message || 'Failed to add candidate', 'error');
            }
        }

        async function loadPayroll(container) {
    const isAdmin = currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
    const isManager = currentUser.role === 'Manager' || isAdmin;
    
    container.innerHTML = `
        <div class="page-transition">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Payroll</h2>
                    <p class="text-slate-500">Manage employee compensation</p>
                </div>
                <button onclick="createPayrollForm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>Submit for Payment
                </button>
            </div>
            
            ${isManager ? `
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4">
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-1">Employee</label>
                        <select id="payroll-filter-user" onchange="loadPayrollData()" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-1">Status</label>
                        <select id="payroll-filter-status" onchange="loadPayrollData()" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                            <option value="">All Status</option>
                            <option value="Draft">Draft</option>
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Paid">Paid</option>
                        </select>
                    </div>
                    <button onclick="loadPayrollData()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200">
                        <i class="fas fa-filter mr-1"></i>Refresh
                    </button>
                </div>
            </div>
            ` : ''}
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="px-4 py-3 font-medium text-slate-700">Employee</th>
                                <th class="px-4 py-3 font-medium text-slate-700">Period</th>
                                <th class="px-4 py-3 font-medium text-slate-700">Type</th>
                                <th class="px-4 py-3 font-medium text-slate-700 text-right">Base</th>
                                <th class="px-4 py-3 font-medium text-slate-700 text-right">Total</th>
                                <th class="px-4 py-3 font-medium text-slate-700">Status</th>
                                ${isManager ? '<th class="px-4 py-3 font-medium text-slate-700">Actions</th>' : ''}
                            </tr>
                        </thead>
                        <tbody id="payroll-table-body" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="${isManager ? 7 : 6}" class="px-4 py-8 text-center">
                                    <i class="fas fa-circle-notch fa-spin text-blue-600 mr-2"></i>Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    if (isManager) {
        try {
            let users = getCached('users');
            if (!users) {
                const userData = await apiCall('users');
                users = userData.users || [];
                setCached('users', users);
            }
            const userSelect = document.getElementById('payroll-filter-user');
            users.forEach(u => {
                if (u.active !== false) {
                    const option = document.createElement('option');
                    option.value = u.user_id;
                    option.textContent = u.name;
                    userSelect.appendChild(option);
                }
            });
        } catch (e) {
            console.error('Failed to load users:', e);
        }
    }
    
    await loadPayrollData();
}

async function loadPayrollData() {
    const isAdmin = currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
    const isManager = currentUser.role === 'Manager' || isAdmin;
    
    const userFilter = isManager ? document.getElementById('payroll-filter-user')?.value : '';
    const statusFilter = isManager ? document.getElementById('payroll-filter-status')?.value : '';
    
    try {
        const params = {};
        if (!isAdmin && !isManager) {
            params.user_id = currentUser.user_id;
        } else if (userFilter) {
            params.user_id = userFilter;
        }
        if (statusFilter) params.status = statusFilter;
        
        const data = await apiCall('payroll', params);
        const payrolls = data.payroll || [];
        
        let users = getCached('users');
        if (!users) {
            const userData = await apiCall('users');
            users = userData.users || [];
            setCached('users', users);
        }
        const userMap = {};
        users.forEach(u => userMap[u.user_id] = u.name);
        
        if (payrolls.length === 0) {
            document.getElementById('payroll-table-body').innerHTML = 
                `<tr><td colspan="${isManager ? 7 : 6}" class="px-4 py-8 text-center text-slate-400">No payroll records found</td></tr>`;
            return;
        }
        
        const statusColors = {
            'Draft': 'bg-slate-100 text-slate-600', 
            'Pending': 'bg-amber-100 text-amber-600', 
            'Approved': 'bg-blue-100 text-blue-600', 
            'Paid': 'bg-green-100 text-green-600'
        };
        
        const rows = payrolls.map(p => {
            let actions = '';
            if (isManager) {
                if (p.status === 'Draft' || p.status === 'Pending') {
                    actions = `<button onclick="approvePayroll(${p.payroll_id})" class="text-blue-600 hover:text-blue-800 font-medium">Approve</button>`;
                } else if (p.status === 'Approved' && isAdmin) {
                    actions = `<button onclick="markPaid(${p.payroll_id})" class="text-green-600 hover:text-green-800 font-medium">Mark Paid</button>`;
                } else {
                    actions = '-';
                }
            }
            return `
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3 font-medium text-slate-900">${userMap[p.user_id] || 'Employee #' + p.user_id}</td>
                    <td class="px-4 py-3 text-slate-600">${p.period_start} to ${p.period_end}</td>
                    <td class="px-4 py-3 text-slate-600">${getPayType(p)}</td>
                    <td class="px-4 py-3 text-right text-slate-900">$${p.base_amount.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right font-bold text-slate-900">$${p.total_pay.toFixed(2)}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[p.status] || 'bg-slate-100 text-slate-600'}">${p.status}</span>
                    </td>
                    ${isManager ? `<td class="px-4 py-3">${actions}</td>` : ''}
                </tr>
            `;
        }).join('');
        
        document.getElementById('payroll-table-body').innerHTML = rows;
    } catch (e) {
        document.getElementById('payroll-table-body').innerHTML = 
            `<tr><td colspan="${isManager ? 7 : 6}" class="px-4 py-8 text-center text-red-500">${e.message || 'Failed to load payroll'}</td></tr>`;
    }
}

        function getPayType(p) {
            if (p.hours_worked > 0) return 'Hourly';
            if (p.tasks_completed > 0) return 'Task';
            return 'Salary';
        }

        async function createPayrollForm() {
    const isAdmin = currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
    const isManager = currentUser.role === 'Manager' || isAdmin;
    let employeeOptions = '';
    
    if (isManager) {
        try {
            let users = getCached('users');
            if (!users) {
                const userData = await apiCall('users');
                users = userData.users || [];
                setCached('users', users);
            }
            allUsers = users;
            employeeOptions = users.map(u => 
                `<option value="${u.user_id}" ${u.user_id === currentUser.user_id ? 'selected' : ''}>${u.name} (${u.email})</option>`
            ).join('');
        } catch(e) {
            console.error('Failed to load users:', e);
        }
    }
    
    const modal = document.createElement('div');
    modal.id = 'payroll-modal';
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-xl font-bold text-slate-900 mb-4">Submit for Payment</h3>
                <div class="space-y-4">
                    ${isManager ? `
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Employee</label>
                        <select id="pp-employee" class="w-full px-3 py-2 border border-slate-300 rounded-lg">${employeeOptions}</select>
                    </div>
                    ` : `<input type="hidden" id="pp-employee" value="${currentUser.user_id}">`}
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Period Start</label>
                            <input type="date" id="pp-start" value="${getDefaultPeriodStart()}" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Period End</label>
                            <input type="date" id="pp-end" value="${getDefaultPeriodEnd()}" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Pay Type</label>
                        <select id="pp-type" onchange="updatePayrollFormFields()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            <option value="task_based">Task Based</option>
                            <option value="hourly">Hourly</option>
                            <option value="salary">Salary</option>
                        </select>
                    </div>
                    <div id="field-task" class="space-y-3">
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Tasks Completed</label>
                                <input type="number" id="pp-task-count" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Total Task Payments ($)</label>
                                <input type="number" id="pp-task-pay" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            </div>
                        </div>
                        <button onclick="loadDoneTasksForSelection()" type="button" class="w-full py-2 bg-indigo-100 text-indigo-700 rounded-lg font-medium hover:bg-indigo-200 transition-colors">
                            <i class="fas fa-list-check mr-2"></i>Select from Completed Tasks
                        </button>
                        <div id="done-tasks-list" class="mt-2"></div>
                        <div id="selected-tasks-count" class="text-sm text-slate-600"></div>
                        <input type="hidden" id="selected-task-ids" value="[]">
                    </div>
                    <div id="field-hourly" class="hidden space-y-3">
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Hourly Rate ($)</label>
                                <input type="number" id="pp-rate" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Hours Worked</label>
                                <input type="number" id="pp-hours" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            </div>
                        </div>
                        <button onclick="loadDoneTasksForHourlySelection()" type="button" class="w-full py-2 bg-indigo-100 text-indigo-700 rounded-lg font-medium hover:bg-indigo-200 transition-colors">
                            <i class="fas fa-list-check mr-2"></i>Select from Completed Tasks
                        </button>
                        <div id="hourly-tasks-list" class="mt-2"></div>
                        <div id="hourly-selected-total" class="text-sm text-slate-600"></div>
                    </div>
                    <div id="field-salary" class="hidden">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Base Salary ($)</label>
                        <input type="number" id="pp-salary" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Description / Notes</label>
                        <textarea id="pp-description" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="Reason for payment, adjustments, etc."></textarea>
                    </div>
                    ${isManager ? `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Deductions ($)</label>
                            <input type="number" id="pp-deductions" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Bonus ($)</label>
                            <input type="number" id="pp-bonus" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                        </div>
                    </div>
                    ` : `
                    <input type="hidden" id="pp-deductions" value="0">
                    <input type="hidden" id="pp-bonus" value="0">
                    `}
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-slate-700">Total Pay:</span>
                            <span id="pp-total" class="text-2xl font-bold text-green-600">$0.00</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="submitPayrollForm()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">Submit Request</button>
                    <button onclick="closePayrollForm()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    updatePayrollFormFields();
}
            
        function getTodayDate() {
    const d = new Date();
    const offset = d.getTimezoneOffset();
    const localDate = new Date(d.getTime() - (offset * 60 * 1000));
    return localDate.toISOString().split('T')[0];
}

function getDefaultPeriodStart() {
    const d = new Date();
    d.setDate(d.getDate() - 14);
    const offset = d.getTimezoneOffset();
    const localDate = new Date(d.getTime() - (offset * 60 * 1000));
    return localDate.toISOString().split('T')[0];
}

function getDefaultPeriodEnd() {
    return getTodayDate();
}

        function updatePayrollFormFields() {
            const type = document.getElementById('pp-type').value;
            document.getElementById('field-salary').classList.toggle('hidden', type !== 'salary');
            document.getElementById('field-hourly').classList.toggle('hidden', type !== 'hourly');
            document.getElementById('field-task').classList.toggle('hidden', type !== 'task_based');
            calculatePayrollTotal();
        }

        function calculatePayrollTotal() {
            const type = document.getElementById('pp-type').value;
            let base = 0;
            if (type === 'salary') {
                base = parseFloat(document.getElementById('pp-salary').value) || 0;
            } else if (type === 'hourly') {
                const rate = parseFloat(document.getElementById('pp-rate').value) || 0;
                const hours = parseFloat(document.getElementById('pp-hours').value) || 0;
                base = rate * hours;
            } else if (type === 'task_based') {
                base = parseFloat(document.getElementById('pp-task-pay').value) || 0;
            }
            const deductions = parseFloat(document.getElementById('pp-deductions')?.value) || 0;
            const bonus = parseFloat(document.getElementById('pp-bonus')?.value) || 0;
            const total = base - deductions + bonus;
            document.getElementById('pp-total').textContent = '$' + total.toFixed(2);
        }

        async function loadDoneTasksForHourlySelection() {
            const employeeId = document.getElementById('pp-employee').value || currentUser.user_id;
            const periodStart = document.getElementById('pp-start').value;
            const periodEnd = document.getElementById('pp-end').value;
            const taskListDiv = document.getElementById('hourly-tasks-list');
            
            taskListDiv.innerHTML = '<p class="text-sm text-slate-500"><i class="fas fa-spinner fa-spin mr-1"></i>Loading...</p>';
            
            try {
                const data = await apiCall('payroll/calculate', {
                    user_id: employeeId,
                    period_start: periodStart,
                    period_end: periodEnd,
                    use_timesheets: 'true'
                });
                
                if (!data.task_details || data.task_details.length === 0) {
                    taskListDiv.innerHTML = '<p class="text-sm text-slate-500 italic">No hours logged in this period</p>';
                    return;
                }
                
                let tasks = getCached('tasks');
                if (!tasks) {
                    const tasksData = await apiCall('tasks');
                    tasks = tasksData.tasks || [];
                    setCached('tasks', tasks);
                }
                const tasksMap = {};
                tasks.forEach(t => tasksMap[t.task_id] = t.title);
                
                let html = '<div class="space-y-2 max-h-48 overflow-y-auto border border-slate-200 rounded-lg p-2">';
                
                data.task_details.forEach((task) => {
                    const taskName = tasksMap[task.task_id] || 'Task #' + task.task_id;
                    html += `
                        <div class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer" onclick="toggleHourlyTaskSelection(this, ${task.total_hours})">
                            <input type="checkbox" class="hourly-task-checkbox rounded text-blue-600" data-hours="${task.total_hours}" data-task-id="${task.task_id}" onchange="updateHourlySelectionTotal()">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-slate-900">${taskName}</p>
                                <p class="text-xs text-slate-500">${task.total_hours.toFixed(2)} hours</p>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                html += `<div class="mt-2 text-right"><span class="text-sm font-medium text-slate-700">Selected Hours: </span><span id="hourly-selected-total-display" class="text-lg font-bold text-green-600">0.00</span></div>`;
                html += `<button onclick="applyHourlyTaskSelection()" type="button" class="mt-2 w-full py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">Apply Selection</button>`;
                
                taskListDiv.innerHTML = html;
            } catch (e) {
                taskListDiv.innerHTML = '<p class="text-sm text-red-500">Failed to load tasks: ' + e.message + '</p>';
            }
        }

        function toggleHourlyTaskSelection(row, hours) {
            const checkbox = row.querySelector('.hourly-task-checkbox');
            checkbox.checked = !checkbox.checked;
            updateHourlySelectionTotal();
        }

        function updateHourlySelectionTotal() {
            const checkboxes = document.querySelectorAll('.hourly-task-checkbox:checked');
            let totalHours = 0;
            checkboxes.forEach(cb => {
                totalHours += parseFloat(cb.dataset.hours) || 0;
            });
            const display = document.getElementById('hourly-selected-total-display');
            if (display) display.textContent = totalHours.toFixed(2);
        }

        function applyHourlyTaskSelection() {
            const checkboxes = document.querySelectorAll('.hourly-task-checkbox:checked');
            let totalHours = 0;
            
            checkboxes.forEach(cb => {
                totalHours += parseFloat(cb.dataset.hours) || 0;
            });
            
            document.getElementById('pp-hours').value = totalHours.toFixed(2);
            calculatePayrollTotal();
            
            document.getElementById('hourly-tasks-list').innerHTML = '';
            showToast(`Applied ${totalHours.toFixed(2)} hours from selected tasks`);
        }

        async function loadDoneTasksForSelection() {
            const employeeId = document.getElementById('pp-employee').value || currentUser.user_id;
            const taskListDiv = document.getElementById('done-tasks-list');
            
            taskListDiv.innerHTML = '<p class="text-sm text-slate-500"><i class="fas fa-spinner fa-spin mr-1"></i>Loading...</p>';
            
            try {
                let tasks = getCached('tasks');
                if (!tasks) {
                    const data = await apiCall('tasks', {assignee: employeeId, status: 'Done'});
                    tasks = data.tasks || [];
                } else {
                    tasks = tasks.filter(t => t.assigned_to == employeeId && t.status === 'Done');
                }
                
                const unpaidTasks = tasks.filter(t => !t.paid);
                
                if (unpaidTasks.length === 0) {
                    taskListDiv.innerHTML = '<p class="text-sm text-slate-500 italic">No unpaid completed tasks found</p>';
                    return;
                }
                
                let html = '<div class="space-y-2 max-h-40 overflow-y-auto border border-slate-200 rounded-lg p-2">';
                
                unpaidTasks.forEach((task) => {
                    const payAmount = parseFloat(task.pay_per_task) || 0;
                    html += `
                        <div class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer" onclick="toggleTaskSelection(this, ${payAmount})">
                            <input type="checkbox" class="task-select-checkbox rounded text-blue-600" data-pay="${payAmount}" data-task-id="${task.task_id}" onchange="updateSelectedTasksTotal()">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-slate-900">${task.title}</p>
                                <p class="text-xs text-slate-500">$${payAmount.toFixed(2)}</p>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                html += `<div class="mt-2 text-right"><span class="text-sm font-medium text-slate-700">Selected Total: </span><span id="selected-tasks-total" class="text-lg font-bold text-green-600">$0.00</span></div>`;
                html += `<button onclick="applySelectedTasks()" type="button" class="mt-2 w-full py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">Apply Selected Tasks</button>`;
                
                taskListDiv.innerHTML = html;
            } catch (e) {
                taskListDiv.innerHTML = '<p class="text-sm text-red-500">Failed to load tasks</p>';
            }
        }

        function toggleTaskSelection(row, payAmount) {
            const checkbox = row.querySelector('.task-select-checkbox');
            checkbox.checked = !checkbox.checked;
            updateSelectedTasksTotal();
        }

        function updateSelectedTasksTotal() {
            const checkboxes = document.querySelectorAll('.task-select-checkbox:checked');
            let total = 0;
            let count = 0;
            checkboxes.forEach(cb => {
                total += parseFloat(cb.dataset.pay) || 0;
                count++;
            });
            document.getElementById('selected-tasks-total').textContent = '$' + total.toFixed(2);
            const countEl = document.getElementById('selected-tasks-count');
            if (countEl) countEl.textContent = count + ' tasks selected';
        }

        function applySelectedTasks() {
            const checkboxes = document.querySelectorAll('.task-select-checkbox:checked');
            let totalPay = 0;
            let count = 0;
            const selectedTaskIds = [];
            
            checkboxes.forEach(cb => {
                totalPay += parseFloat(cb.dataset.pay) || 0;
                count++;
                selectedTaskIds.push(cb.dataset.taskId);
            });
            
            document.getElementById('pp-task-count').value = count;
            document.getElementById('pp-task-pay').value = totalPay.toFixed(2);
            document.getElementById('selected-task-ids').value = JSON.stringify(selectedTaskIds);
            calculatePayrollTotal();
            
            document.getElementById('done-tasks-list').innerHTML = '';
            showToast(`Applied ${count} tasks, $${totalPay.toFixed(2)}`);
        }

        function closePayrollForm() {
            document.getElementById('payroll-modal')?.remove();
        }

        async function submitPayrollForm() {
    const employeeId = document.getElementById('pp-employee').value || currentUser.user_id;
    const type = document.getElementById('pp-type').value;
    const description = document.getElementById('pp-description').value || '';
    let baseAmount = 0, hoursWorked = 0, tasksCompleted = 0, taskPayments = 0;
    
    if (type === 'salary') {
        baseAmount = parseFloat(document.getElementById('pp-salary').value) || 0;
    } else if (type === 'hourly') {
        const rate = parseFloat(document.getElementById('pp-rate').value) || 0;
        hoursWorked = parseFloat(document.getElementById('pp-hours').value) || 0;
        baseAmount = rate * hoursWorked;
    } else if (type === 'task_based') {
        tasksCompleted = parseFloat(document.getElementById('pp-task-count').value) || 0;
        taskPayments = parseFloat(document.getElementById('pp-task-pay').value) || 0;
        baseAmount = taskPayments;
    }
    
    const deductions = parseFloat(document.getElementById('pp-deductions')?.value) || 0;
    const bonus = parseFloat(document.getElementById('pp-bonus')?.value) || 0;
    const totalPay = baseAmount - deductions + bonus;
    
    const selectedTaskIds = document.getElementById('selected-task-ids')?.value || '[]';
    
    const payload = {
        method: 'POST',
        user_id: employeeId,
        period_start: document.getElementById('pp-start').value,
        period_end: document.getElementById('pp-end').value,
        base_amount: baseAmount,
        hours_worked: hoursWorked,
        tasks_completed: tasksCompleted,
        task_payments: taskPayments,
        deductions: deductions,
        bonus: bonus,
        total_pay: totalPay,
        task_ids: selectedTaskIds,
        description: description
    };
    
    try {
        await apiCall('payroll', payload);
        closePayrollForm();
        clearCache();
        showToast('Payment request submitted');
        showModule('payroll');
    } catch (e) {
        showToast(e.message || 'Failed to submit request', 'error');
    }
}

        async function approvePayroll(payrollId) {
            try {
                await apiCall('payroll/approve', {payroll_id: payrollId});
                clearCache();
                showToast('Payment approved');
                showModule('payroll');
            } catch (e) {
                showToast(e.message || 'Approval failed', 'error');
            }
        }

        async function markPaid(payrollId) {
            try {
                await apiCall('payroll/pay', {payroll_id: payrollId});
                clearCache();
                showToast('Payment marked as paid');
                showModule('payroll');
            } catch (e) {
                showToast(e.message || 'Failed to mark paid', 'error');
            }
        }

        async function loadTimesheets(container) {
            const isManager = currentUser.role === 'Manager' || currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
            
            container.innerHTML = `
                <div class="page-transition">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Timesheets</h2>
                            <p class="text-slate-500">Log and view work hours</p>
                        </div>
                        <button onclick="openLogHoursModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Log Hours
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                        <div class="p-4 border-b border-slate-200">
                            <div class="flex flex-wrap gap-4 items-end">
                                ${isManager ? `
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">Employee</label>
                                    <select id="ts-filter-user" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="">All Employees</option>
                                    </select>
                                </div>
                                ` : ''}
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">From</label>
                                    <input type="date" id="ts-filter-from" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">To</label>
                                    <input type="date" id="ts-filter-to" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                </div>
                                <button onclick="loadTimesheetData()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200">
                                    <i class="fas fa-filter mr-1"></i>Filter
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-4 py-3 font-medium text-slate-700">Date</th>
                                        ${isManager ? '<th class="px-4 py-3 font-medium text-slate-700">Employee</th>' : ''}
                                        <th class="px-4 py-3 font-medium text-slate-700">Task</th>
                                        <th class="px-4 py-3 font-medium text-slate-700 text-right">Hours</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="timesheet-table-body" class="divide-y divide-slate-100">
                                    <tr>
                                        <td colspan="${isManager ? 5 : 4}" class="px-4 py-8 text-center">
                                            <i class="fas fa-circle-notch fa-spin text-blue-600 mr-2"></i>Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="timesheet-summary" class="p-4 bg-slate-50 border-t border-slate-200">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-slate-700">Total Hours:</span>
                                <span id="ts-total-hours" class="text-xl font-bold text-blue-600">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('ts-filter-from').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('ts-filter-to').value = today.toISOString().split('T')[0];
            
            if (isManager) {
                try {
                    let users = getCached('users');
                    if (!users) {
                        const userData = await apiCall('users');
                        users = userData.users || [];
                        setCached('users', users);
                    }
                    const userSelect = document.getElementById('ts-filter-user');
                    users.forEach(u => {
                        if (u.active !== false) {
                            const option = document.createElement('option');
                            option.value = u.user_id;
                            option.textContent = u.name;
                            userSelect.appendChild(option);
                        }
                    });
                } catch (e) {
                    console.error('Failed to load users:', e);
                }
            }
            
            await loadTimesheetData();
        }

        async function loadTimesheetData() {
            const isManager = currentUser.role === 'Manager' || currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
            const userId = isManager ? document.getElementById('ts-filter-user').value : currentUser.user_id;
            const dateFrom = document.getElementById('ts-filter-from').value;
            const dateTo = document.getElementById('ts-filter-to').value;
            
            try {
                const params = {
                    date_from: dateFrom,
                    date_to: dateTo
                };
                if (userId) params.user_id = userId;
                
                const data = await apiCall('timesheets', params);
                const entries = data.timesheets || [];
                
                let tasks = getCached('tasks');
                if (!tasks) {
                    const tasksData = await apiCall('tasks');
                    tasks = tasksData.tasks || [];
                    setCached('tasks', tasks);
                }
                const tasksMap = {};
                tasks.forEach(t => tasksMap[t.task_id] = t.title);
                
                if (entries.length === 0) {
                    document.getElementById('timesheet-table-body').innerHTML = 
                        `<tr><td colspan="${isManager ? 5 : 4}" class="px-4 py-8 text-center text-slate-400">No timesheet entries found</td></tr>`;
                    document.getElementById('ts-total-hours').textContent = '0';
                    return;
                }
                
                let totalHours = 0;
                const rows = entries.map(e => {
                    totalHours += e.hours;
                    return `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 text-slate-900">${e.date}</td>
                            ${isManager ? `<td class="px-4 py-3 text-slate-600">User #${e.user_id}</td>` : ''}
                            <td class="px-4 py-3 text-slate-900 font-medium">${tasksMap[e.task_id] || 'Task #' + e.task_id}</td>
                            <td class="px-4 py-3 text-right font-bold text-blue-600">${e.hours.toFixed(2)}</td>
                            <td class="px-4 py-3 text-slate-600 text-sm">${e.notes || '-'}</td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('timesheet-table-body').innerHTML = rows;
                document.getElementById('ts-total-hours').textContent = totalHours.toFixed(2);
            } catch (e) {
                document.getElementById('timesheet-table-body').innerHTML = 
                    `<tr><td colspan="${isManager ? 5 : 4}" class="px-4 py-8 text-center text-red-500">${e.message || 'Failed to load timesheets'}</td></tr>`;
            }
        }

        async function openLogHoursModal() {
            try {
                let tasks = getCached('tasks');
                if (!tasks) {
                    const tasksData = await apiCall('tasks', {assignee: currentUser.user_id});
                    tasks = tasksData.tasks || [];
                } else {
                    tasks = tasks.filter(t => t.assigned_to == currentUser.user_id);
                }
                
                const modal = document.createElement('div');
                modal.id = 'log-hours-modal';
                modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-slate-900 mb-4">Log Work Hours</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Task</label>
                                    <select id="lh-task" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                        <option value="">Select a task...</option>
                                        ${tasks.map(t => `<option value="${t.task_id}">${t.title} (${t.status})</option>`).join('')}
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
                                        <input type="date" id="lh-date" value="${getTodayDate()}" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Hours</label>
                                        <input type="number" id="lh-hours" step="0.25" min="0.25" max="24" placeholder="0.00" class="w-full px-3 py-2 border border-slate-300 rounded-lg" autofocus>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Notes (Optional)</label>
                                    <textarea id="lh-notes" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="What did you work on?"></textarea>
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="submitLogHours()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">Log Hours</button>
                                <button onclick="closeLogHoursModal()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('lh-hours').focus();
            } catch (e) {
                showToast('Failed to load tasks', 'error');
            }
        }

            function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const isHidden = sidebar.classList.contains('hidden');
    
    if (isHidden) {
        // Open sidebar
        sidebar.classList.remove('hidden');
        // Add click-outside listener for mobile
        if (window.innerWidth < 1024) {
            setTimeout(() => {
                document.addEventListener('click', closeSidebarOnClickOutside);
            }, 100);
        }
    } else {
        // Close sidebar
        sidebar.classList.add('hidden');
        document.removeEventListener('click', closeSidebarOnClickOutside);
    }
}

function closeSidebarOnClickOutside(e) {
    const sidebar = document.getElementById('sidebar');
    const menuBtn = document.querySelector('button[onclick="toggleSidebar()"]');
    
    // If click is outside sidebar and not on menu button
    if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
        sidebar.classList.add('hidden');
        document.removeEventListener('click', closeSidebarOnClickOutside);
    }
}

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 shadow-lg transform transition-all duration-300 translate-y-0 ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
            toast.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2"></i>${message}`;
            document.body.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.style.transform = 'translateY(0)';
                toast.style.opacity = '1';
            });
            
            setTimeout(() => {
                toast.style.transform = 'translateY(100%)';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

         // ==================== FINANCIALS FUNCTIONS ====================

        async function loadFinancials(container) {
            const isAdmin = currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
            
            container.innerHTML = `
                <div class="page-transition">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Financials</h2>
                            <p class="text-slate-500">Track income, expenses, and cash flow</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="createInvoiceForm()" class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                                <i class="fas fa-file-invoice-dollar mr-2"></i>New Invoice
                            </button>
                            <button onclick="createBillForm()" class="px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700">
                                <i class="fas fa-file-invoice mr-2"></i>New Bill
                            </button>
                            <button onclick="createTransactionForm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>Transaction
                            </button>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="financials-summary">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div class="animate-pulse h-16 bg-slate-200 rounded"></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div class="animate-pulse h-16 bg-slate-200 rounded"></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div class="animate-pulse h-16 bg-slate-200 rounded"></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div class="animate-pulse h-16 bg-slate-200 rounded"></div>
                        </div>
                    </div>
                    
                    <!-- Transactions Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-200 flex flex-wrap gap-4 items-center">
                            <h3 class="font-semibold text-slate-900">Transactions</h3>
                            <div class="flex gap-2 ml-auto">
                                <select id="fin-type-filter" onchange="loadFinancialsData()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm">
                                    <option value="">All Types</option>
                                    <option value="income">Income</option>
                                    <option value="expense">Expenses</option>
                                </select>
                                <input type="date" id="fin-date-from" onchange="loadFinancialsData()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm">
                                <input type="date" id="fin-date-to" onchange="loadFinancialsData()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm">
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-4 py-3 font-medium text-slate-700">Date</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Type</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Category</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Description</th>
                                        <th class="px-4 py-3 font-medium text-slate-700 text-right">Amount</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Status</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="financials-table-body" class="divide-y divide-slate-100">
                                    <tr><td colspan="7" class="px-4 py-8 text-center text-slate-400">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('fin-date-from').value = firstDay.toISOString().split('T')[0];
            document.getElementById('fin-date-to').value = today.toISOString().split('T')[0];
            
            await loadFinancialsData();
        }

            async function loadFinancialsData() {
    try {
        const typeFilter = document.getElementById('fin-type-filter').value;
        const dateFrom = document.getElementById('fin-date-from').value;
        const dateTo = document.getElementById('fin-date-to').value;
        
        const params = {};
        if (typeFilter) params.type = typeFilter;
        if (dateFrom) params.date_from = dateFrom;
        if (dateTo) params.date_to = dateTo;
        
        const [data, summaryData] = await Promise.all([
            apiCall('financials', params),
            apiCall('financials/summary', {date_from: dateFrom, date_to: dateTo})
        ]);
        
        const transactions = data.transactions || [];
        const summary = summaryData.summary || {};
        
        document.getElementById('financials-summary').innerHTML = `
            <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                <p class="text-sm text-green-700 font-medium">Total Income (Paid)</p>
                <p class="text-2xl font-bold text-green-700">$${(summary.total_income || 0).toFixed(2)}</p>
            </div>
            <div class="bg-red-50 p-4 rounded-xl border border-red-200">
                <p class="text-sm text-red-700 font-medium">Total Expenses (Paid)</p>
                <p class="text-2xl font-bold text-red-700">$${(summary.total_expenses || 0).toFixed(2)}</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                <p class="text-sm text-blue-700 font-medium">Net Profit</p>
                <p class="text-2xl font-bold text-blue-700">$${(summary.net_profit || 0).toFixed(2)}</p>
            </div>
            <div class="bg-amber-50 p-4 rounded-xl border border-amber-200">
                <p class="text-sm text-amber-700 font-medium">Pending</p>
                <p class="text-lg font-bold text-amber-700">+$${(summary.pending_receivables || 0).toFixed(2)} receivable</p>
                <p class="text-lg font-bold text-amber-700">-$${(summary.pending_payables || 0).toFixed(2)} payable</p>
            </div>
        `;
        
        if (transactions.length === 0) {
            document.getElementById('financials-table-body').innerHTML = 
                '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-400">No transactions found</td></tr>';
            return;
        }
        
        const rows = transactions.map(t => {
            const typeColors = {
                'income': 'text-green-600 bg-green-50',
                'expense': 'text-red-600 bg-red-50',
                'transfer': 'text-blue-600 bg-blue-50'
            };
            const statusColors = {
                'paid': 'bg-green-100 text-green-700',
                'pending': 'bg-amber-100 text-amber-700',
                'sent': 'bg-blue-100 text-blue-700',
                'overdue': 'bg-red-100 text-red-700'
            };
            
            let actions = '';
            if (t.status === 'pending') {
                if (t.type === 'expense' && t.subtype === 'bill') {
                    actions = `<button onclick="payBill(${t.transaction_id})" class="text-green-600 hover:text-green-800 font-medium">Pay</button>`;
                } else if (t.type === 'income' && t.subtype === 'invoice') {
                    actions = `<button onclick="sendInvoice(${t.transaction_id})" class="text-blue-600 hover:text-blue-800 font-medium">Send</button>`;
                }
            } else if (t.status === 'sent' && t.type === 'income' && t.subtype === 'invoice') {
                // ADDED: Mark as Paid button for sent invoices
                actions = `<button onclick="markInvoicePaid(${t.transaction_id})" class="text-green-600 hover:text-green-800 font-medium">Mark Paid</button>`;
            } else {
                actions = '-';
            }
            
            return `
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3 text-slate-900">${t.date}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${typeColors[t.type] || 'bg-slate-100 text-slate-600'}">
                            ${t.subtype || t.type}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-slate-600 capitalize">${t.category}</td>
                    <td class="px-4 py-3 text-slate-900">${t.description}</td>
                    <td class="px-4 py-3 text-right font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${t.type === 'income' ? '+' : '-'}$${(t.amount || 0).toFixed(2)}
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[t.status] || 'bg-slate-100 text-slate-600'}">
                            ${t.status}
                        </span>
                    </td>
                    <td class="px-4 py-3">${actions}</td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('financials-table-body').innerHTML = rows;
        
    } catch (e) {
        document.getElementById('financials-table-body').innerHTML = 
            `<tr><td colspan="7" class="px-4 py-8 text-center text-red-500">${e.message || 'Failed to load financials'}</td></tr>`;
    }
}
            async function markInvoicePaid(invoiceId) {
    try {
        await apiCall('invoices/pay', {invoice_id: invoiceId});
        clearCache();
        showToast('Invoice marked as paid');
        loadFinancialsData();
    } catch (e) {
        showToast(e.message || 'Failed to mark invoice as paid', 'error');
    }
}

        function createTransactionForm() {
            const modal = document.createElement('div');
            modal.id = 'transaction-modal';
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-900 mb-4">New Transaction</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Type</label>
                                <select id="trans-type" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                    <option value="expense">Expense</option>
                                    <option value="income">Income</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                                <input type="text" id="trans-category" placeholder="e.g., supplies, services" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Amount ($)</label>
                                    <input type="number" id="trans-amount" step="0.01" min="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
                                    <input type="date" id="trans-date" value="${getTodayDate()}" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                                <textarea id="trans-description" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="submitTransaction()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">Save</button>
                            <button onclick="closeTransactionModal()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeTransactionModal() {
            document.getElementById('transaction-modal')?.remove();
        }

        async function submitTransaction() {
            const type = document.getElementById('trans-type').value;
            const category = document.getElementById('trans-category').value;
            const amount = parseFloat(document.getElementById('trans-amount').value);
            const date = document.getElementById('trans-date').value;
            const description = document.getElementById('trans-description').value;
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            try {
                await apiCall('financials', {
                    method: 'POST',
                    type: type,
                    category: category,
                    amount: amount,
                    date: date,
                    description: description,
                    status: 'paid'
                });
                
                closeTransactionModal();
                clearCache();
                showToast('Transaction saved');
                loadFinancialsData();
            } catch (e) {
                showToast(e.message || 'Failed to save transaction', 'error');
            }
        }

        function createInvoiceForm() {
            const modal = document.createElement('div');
            modal.id = 'invoice-modal';
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-900 mb-4">New Invoice</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Client</label>
                                <input type="text" id="inv-client" placeholder="Client name or ID" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Amount ($)</label>
                                    <input type="number" id="inv-amount" step="0.01" min="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Due Date</label>
                                    <input type="date" id="inv-due" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                                <textarea id="inv-description" rows="2" placeholder="Invoice for..." class="w-full px-3 py-2 border border-slate-300 rounded-lg"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="submitInvoice()" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700">Create Invoice</button>
                            <button onclick="document.getElementById('invoice-modal').remove()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitInvoice() {
            const clientId = document.getElementById('inv-client').value;
            const amount = parseFloat(document.getElementById('inv-amount').value);
            const dueDate = document.getElementById('inv-due').value;
            const description = document.getElementById('inv-description').value;
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            try {
                await apiCall('invoices', {
                    method: 'POST',
                    client_id: clientId,
                    amount: amount,
                    due_date: dueDate,
                    description: description
                });
                
                document.getElementById('invoice-modal').remove();
                clearCache();
                showToast('Invoice created');
                loadFinancialsData();
            } catch (e) {
                showToast(e.message || 'Failed to create invoice', 'error');
            }
        }

        function createBillForm() {
            const modal = document.createElement('div');
            modal.id = 'bill-modal';
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-900 mb-4">New Bill</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Vendor</label>
                                <input type="text" id="bill-vendor" placeholder="Vendor name" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Amount ($)</label>
                                    <input type="number" id="bill-amount" step="0.01" min="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Due Date</label>
                                    <input type="date" id="bill-due" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                                <textarea id="bill-description" rows="2" placeholder="Bill for..." class="w-full px-3 py-2 border border-slate-300 rounded-lg"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="submitBill()" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-medium hover:bg-red-700">Create Bill</button>
                            <button onclick="document.getElementById('bill-modal').remove()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitBill() {
            const vendorId = document.getElementById('bill-vendor').value;
            const amount = parseFloat(document.getElementById('bill-amount').value);
            const dueDate = document.getElementById('bill-due').value;
            const description = document.getElementById('bill-description').value;
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            try {
                await apiCall('bills', {
                    method: 'POST',
                    vendor_id: vendorId,
                    amount: amount,
                    due_date: dueDate,
                    description: description
                });
                
                document.getElementById('bill-modal').remove();
                clearCache();
                showToast('Bill created');
                loadFinancialsData();
            } catch (e) {
                showToast(e.message || 'Failed to create bill', 'error');
            }
        }

        async function payBill(billId) {
            try {
                await apiCall('bills/pay', {bill_id: billId});
                clearCache();
                showToast('Bill paid');
                loadFinancialsData();
            } catch (e) {
                showToast(e.message || 'Failed to pay bill', 'error');
            }
        }

        async function sendInvoice(invoiceId) {
            try {
                await apiCall('invoices/send', {invoice_id: invoiceId});
                clearCache();
                showToast('Invoice sent');
                loadFinancialsData();
            } catch (e) {
                showToast(e.message || 'Failed to send invoice', 'error');
            }
        }

        // ==================== CRM MODULE ====================

async function loadCRM(container) {
    const isManager = currentUser.role === 'Manager' || currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
    
    container.innerHTML = `
        <div class="page-transition">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">CRM</h2>
                    <p class="text-slate-500">Manage clients and leads</p>
                </div>
                <button onclick="createClientForm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>Add Client
                </button>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b border-slate-200 flex flex-wrap gap-4 items-center">
                    <h3 class="font-semibold text-slate-900">Clients & Leads</h3>
                    <div class="flex gap-2 ml-auto">
                        <select id="crm-status-filter" onchange="loadCRMData()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm">
                            <option value="">All Status</option>
                            <option value="lead">Lead</option>
                            <option value="prospect">Prospect</option>
                            <option value="customer">Customer</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="px-4 py-3 font-medium text-slate-700">Company</th>
                                <th class="px-4 py-3 font-medium text-slate-700">Contact</th>
                                <th class="px-4 py-3 font-medium text-slate-700">Email</th>
                                <th class="px-4 py-3 font-medium text-slate-700">Status</th>
                                <th class="px-4 py-3 font-medium text-slate-700 text-right">Value</th>
                                <th class="px-4 py-3 font-medium text-slate-700">Last Contact</th>
                            </tr>
                        </thead>
                        <tbody id="crm-table-body" class="divide-y divide-slate-100">
                            <tr><td colspan="6" class="px-4 py-8 text-center text-slate-400">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    await loadCRMData();
}

async function loadCRMData() {
    try {
        const statusFilter = document.getElementById('crm-status-filter').value;
        const params = statusFilter ? {status: statusFilter} : {};
        
        const data = await apiCall('crm', params);
        const clients = data.clients || [];
        
        if (clients.length === 0) {
            document.getElementById('crm-table-body').innerHTML = 
                '<tr><td colspan="6" class="px-4 py-8 text-center text-slate-400">No clients found</td></tr>';
            return;
        }
        
        const statusColors = {
            'lead': 'bg-purple-100 text-purple-700',
            'prospect': 'bg-blue-100 text-blue-700',
            'customer': 'bg-green-100 text-green-700',
            'inactive': 'bg-slate-100 text-slate-600'
        };
        
        const rows = clients.map(c => `
            <tr class="hover:bg-slate-50">
                <td class="px-4 py-3 font-medium text-slate-900">${c.company_name || '-'}</td>
                <td class="px-4 py-3 text-slate-900">${c.contact_name || '-'}</td>
                <td class="px-4 py-3 text-slate-600">${c.email || '-'}</td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[c.status] || 'bg-slate-100 text-slate-600'}">
                        ${c.status}
                    </span>
                </td>
                <td class="px-4 py-3 text-right font-bold text-slate-900">
                    ${c.value > 0 ? '$' + c.value.toFixed(2) : '-'}
                </td>
                <td class="px-4 py-3 text-slate-600">${c.last_contact || 'Never'}</td>
            </tr>
        `).join('');
        
        document.getElementById('crm-table-body').innerHTML = rows;
    } catch (e) {
        document.getElementById('crm-table-body').innerHTML = 
            `<tr><td colspan="6" class="px-4 py-8 text-center text-red-500">${e.message || 'Failed to load CRM'}</td></tr>`;
    }
}

function createClientForm() {
    const modal = document.createElement('div');
    modal.id = 'client-modal';
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="p-6">
                <h3 class="text-xl font-bold text-slate-900 mb-4">New Client</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Type</label>
                        <select id="client-type" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            <option value="lead">Lead</option>
                            <option value="prospect">Prospect</option>
                            <option value="customer">Customer</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Company Name</label>
                        <input type="text" id="client-company" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Contact Name</label>
                        <input type="text" id="client-contact" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input type="email" id="client-email" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Phone</label>
                        <input type="tel" id="client-phone" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Potential Value ($)</label>
                        <input type="number" id="client-value" step="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="submitClient()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">Save Client</button>
                    <button onclick="document.getElementById('client-modal').remove()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function submitClient() {
    const type = document.getElementById('client-type').value;
    const company = document.getElementById('client-company').value;
    const contact = document.getElementById('client-contact').value;
    const email = document.getElementById('client-email').value;
    const phone = document.getElementById('client-phone').value;
    const value = parseFloat(document.getElementById('client-value').value) || 0;
    
    if (!company && !contact) {
        showToast('Please enter company or contact name', 'error');
        return;
    }
    
    try {
        await apiCall('crm', {
            method: 'POST',
            type: type,
            company_name: company,
            contact_name: contact,
            email: email,
            phone: phone,
            value: value
        });
        
        document.getElementById('client-modal').remove();
        clearCache();
        showToast('Client added');
        loadCRMData();
    } catch (e) {
        showToast(e.message || 'Failed to add client', 'error');
    }
}

// ==================== PROJECTS MODULE ====================

async function loadProjects(container) {
    container.innerHTML = `
        <div class="page-transition">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Projects</h2>
                    <p class="text-slate-500">Track project progress and budgets</p>
                </div>
                <button onclick="createProjectForm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>New Project
                </button>
            </div>
            
            <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-circle-notch fa-spin text-3xl text-blue-600"></i>
                </div>
            </div>
        </div>
    `;
    
    await loadProjectsData();
}

async function createTaskForProject(projectId, projectName) {
    let project = null;
    try {
        let projects = getCached('projects');
        if (!projects) {
            const projData = await apiCall('projects');
            projects = projData.projects || [];
            setCached('projects', projects);
        }
        project = projects.find(p => p.project_id == projectId);
    } catch (e) {
        console.error('Failed to fetch project details:', e);
    }
    
    const defaultTitle = project ? `${project.name} - ` : '';
    const defaultDescription = project ? project.description || '' : '';
    const defaultHours = project && project.hourly_budget ? Math.round(project.hourly_budget / 40 * 10) / 10 : '';
    const defaultDueDate = project && project.end_date ? project.end_date : '';
    
    const isManagerOrAbove = currentUser.role === 'Manager' || currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
    
    let assigneeOptions = '';
    if (isManagerOrAbove) {
        try {
            let users = getCached('users');
            if (!users) {
                const userData = await apiCall('users');
                users = userData.users || [];
                setCached('users', users);
            }
            assigneeOptions = users
                .filter(u => u.active !== false)
                .map(u => `<option value="${u.user_id}" ${u.user_id === currentUser.user_id ? 'selected' : ''}>${u.name} (${u.role})</option>`)
                .join('');
        } catch (e) {
            console.error('Failed to load users:', e);
        }
    }
    
    const modal = document.createElement('div');
    modal.id = 'project-task-modal';
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-xl font-bold text-slate-900 mb-1">Create Task</h3>
                <p class="text-sm text-slate-500 mb-4">For project: <span class="font-medium text-blue-600">${projectName}</span></p>
                
                <div class="space-y-4">
                    <input type="hidden" id="pt-project-id" value="${projectId}">
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">
                            Task Title <span class="text-slate-400 text-xs">(Project name pre-filled, editable)</span>
                        </label>
                        <input type="text" id="pt-title" value="${defaultTitle}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Design homepage mockups" autofocus>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">
                            Description <span class="text-slate-400 text-xs">(Copied from project, editable)</span>
                        </label>
                        <textarea id="pt-description" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Details about this task...">${defaultDescription}</textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                            <select id="pt-status" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                <option value="Backlog">Backlog</option>
                                <option value="Todo" selected>Todo</option>
                                <option value="In Progress">In Progress</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Priority</label>
                            <select id="pt-priority" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                                <option value="Urgent">Urgent</option>
                            </select>
                        </div>
                    </div>
                    
                    ${isManagerOrAbove ? `
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Assigned To</label>
                        <select id="pt-assignee" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            ${assigneeOptions}
                        </select>
                    </div>
                    ` : `
                    <input type="hidden" id="pt-assignee" value="${currentUser.user_id}">
                    `}
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">
                                Due Date <span class="text-slate-400 text-xs">(Project deadline)</span>
                            </label>
                            <input type="date" id="pt-due-date" value="${defaultDueDate}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">
                                Est. Hours
                            </label>
                            <input type="number" id="pt-estimated" step="0.5" min="0" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 8">
                            ${project && project.hourly_budget ? `<p class="text-xs text-slate-500 mt-1">Project budget: ${project.hourly_budget}h total</p>` : ''}
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <p class="text-xs text-blue-700">
                            <i class="fas fa-info-circle mr-1"></i>
                            Project budget: <strong>$${project ? (project.budget || 0).toFixed(2) : '0.00'}</strong> | 
                            Hourly budget: <strong>${project ? (project.hourly_budget || 0) : '0'}h</strong>
                        </p>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="pt-billable" class="rounded text-blue-600 w-4 h-4">
                        <label for="pt-billable" class="text-sm text-slate-700">Billable task</label>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="submitProjectTask()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">
                        <i class="fas fa-check mr-1"></i>Create Task
                    </button>
                    <button onclick="document.getElementById('project-task-modal').remove()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    const titleInput = document.getElementById('pt-title');
    titleInput.focus();
    titleInput.setSelectionRange(titleInput.value.length, titleInput.value.length);
}

async function submitProjectTask() {
    const projectId = document.getElementById('pt-project-id').value;
    const title = document.getElementById('pt-title').value;
    const description = document.getElementById('pt-description').value;
    const status = document.getElementById('pt-status').value;
    const priority = document.getElementById('pt-priority').value;
    const dueDate = document.getElementById('pt-due-date').value;
    const estimated = document.getElementById('pt-estimated').value;
    const billable = document.getElementById('pt-billable').checked;
    const assigneeId = document.getElementById('pt-assignee').value;
    
    if (!title) {
        showToast('Please enter a task title', 'error');
        return;
    }
    
    try {
        await apiCall('tasks', {
            method: 'POST',
            title: title,
            description: description,
            project_id: projectId,
            assigned_to: assigneeId,
            status: status,
            priority: priority,
            due_date: dueDate,
            estimated_hours: estimated,
            billable: billable
        });
        
        document.getElementById('project-task-modal').remove();
        clearCache();
        showToast('Task created for project');
        
        loadProjectsData();
        
    } catch (e) {
        showToast(e.message || 'Failed to create task', 'error');
    }
}
        
async function loadProjectsData() {
    try {
        const data = await apiCall('projects');
        const projects = data.projects || [];
        
        if (projects.length === 0) {
            document.getElementById('projects-grid').innerHTML = 
                '<div class="col-span-full text-center py-12 text-slate-400">No projects found</div>';
            return;
        }
        
        let tasks = getCached('tasks');
        if (!tasks) {
            const tasksData = await apiCall('tasks');
            tasks = tasksData.tasks || [];
            setCached('tasks', tasks);
        }
        
        const statusColors = {
            'active': 'bg-green-100 text-green-700',
            'completed': 'bg-blue-100 text-blue-700',
            'on-hold': 'bg-amber-100 text-amber-700',
            'cancelled': 'bg-red-100 text-red-700'
        };
        
        const cards = projects.map(p => {
            const projectTasks = tasks.filter(t => t.project_id == p.project_id);
            const totalTasks = projectTasks.length;
            const completedTasks = projectTasks.filter(t => t.status === 'Done').length;
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            const hoursUsed = projectTasks.reduce((sum, t) => sum + (t.actual_hours || 0), 0);
            const hoursBudget = p.hourly_budget || 0;
            const hoursPercent = hoursBudget > 0 ? Math.round((hoursUsed / hoursBudget) * 100) : 0;
            
            return `
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 card-hover">
                <div class="flex items-start justify-between mb-3">
                    <h3 class="font-bold text-slate-900 text-lg">${p.name}</h3>
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[p.status] || 'bg-slate-100 text-slate-600'}">
                        ${p.status}
                    </span>
                </div>
                <p class="text-sm text-slate-600 mb-4 line-clamp-2">${p.description || 'No description'}</p>
                
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-slate-500">Task Progress (${completedTasks}/${totalTasks})</span>
                            <span class="font-medium text-slate-700">${progress}%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    
                    ${hoursBudget > 0 ? `
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-slate-500">Hours (${hoursUsed.toFixed(1)}/${hoursBudget}h)</span>
                            <span class="font-medium ${hoursPercent > 90 ? 'text-red-600' : 'text-slate-700'}">${hoursPercent}%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div class="${hoursPercent > 90 ? 'bg-red-500' : 'bg-amber-500'} h-2 rounded-full transition-all duration-500" style="width: ${Math.min(hoursPercent, 100)}%"></div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-slate-500 text-xs">Budget</p>
                            <p class="font-medium text-slate-900">$${(p.budget || 0).toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-slate-500 text-xs">Due Date</p>
                            <p class="font-medium text-slate-900">${p.end_date || 'Not set'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-slate-100 grid grid-cols-2 gap-2">
                    <button onclick="createTaskForProject(${p.project_id}, '${(p.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" class="py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                        <i class="fas fa-plus mr-1"></i>Create Task
                    </button>
                    <button onclick="viewProjectTasks(${p.project_id})" class="py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200">
                        View Tasks (${totalTasks})
                    </button>
                </div>
            </div>
        `}).join('');
        
        document.getElementById('projects-grid').innerHTML = cards;
    } catch (e) {
        document.getElementById('projects-grid').innerHTML = 
            `<div class="col-span-full text-center py-12 text-red-500">${e.message || 'Failed to load projects'}</div>`;
    }
}

function createProjectForm() {
    const modal = document.createElement('div');
    modal.id = 'project-modal';
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="p-6">
                <h3 class="text-xl font-bold text-slate-900 mb-4">New Project</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Project Name</label>
                        <input type="text" id="proj-name" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                        <textarea id="proj-desc" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Budget ($)</label>
                            <input type="number" id="proj-budget" step="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Hourly Budget</label>
                            <input type="number" id="proj-hours" step="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                            <input type="date" id="proj-start" value="${new Date().toISOString().split('T')[0]}" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">End Date</label>
                            <input type="date" id="proj-end" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="submitProject()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">Create Project</button>
                    <button onclick="document.getElementById('project-modal').remove()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function submitProject() {
    const name = document.getElementById('proj-name').value;
    const desc = document.getElementById('proj-desc').value;
    const budget = parseFloat(document.getElementById('proj-budget').value) || 0;
    const hours = parseFloat(document.getElementById('proj-hours').value) || 0;
    const start = document.getElementById('proj-start').value;
    const end = document.getElementById('proj-end').value;
    
    if (!name) {
        showToast('Please enter project name', 'error');
        return;
    }
    
    try {
        await apiCall('projects', {
            method: 'POST',
            name: name,
            description: desc,
            budget: budget,
            hourly_budget: hours,
            start_date: start,
            end_date: end
        });
        
        document.getElementById('project-modal').remove();
        clearCache();
        showToast('Project created');
        loadProjectsData();
    } catch (e) {
        showToast(e.message || 'Failed to create project', 'error');
    }
}

function viewProjectTasks(projectId) {
    const projects = getCached('projects') || [];
    const project = projects.find(p => p.project_id == projectId);
    const projectName = project ? project.name : 'Project #' + projectId;
    
    showModule('tasks');
    
    sessionStorage.setItem('preselectedProjectId', projectId);
    
    showToast(`Showing tasks for: ${projectName}`);
}

function editProject(projectId) {
    showToast('Edit project #' + projectId + ' (coming soon)');
}

                // ==================== NOTIFICATION SYSTEM (PHASE 4) ====================

        let notificationPollingInterval = null;
        let lastNotificationCount = 0;

        function toggleNotificationDropdown() {
            const dropdown = document.getElementById('notification-dropdown');
            const isHidden = dropdown.classList.contains('hidden');
            
            if (isHidden) {
                dropdown.classList.remove('hidden');
                loadNotifications();
            } else {
                dropdown.classList.add('hidden');
            }
        }

        async function loadNotifications() {
    const listContainer = document.getElementById('notification-list');
    
    try {
        const data = await apiCall('notifications', {limit: 10});
        const notifications = data.notifications || [];
        const unreadCount = data.unread_count || 0;
        
        updateNotificationBadge(unreadCount);
        renderNotificationList(notifications);
    } catch (e) {
        if (e.message && e.message.includes('Failed to load')) {
            listContainer.innerHTML = `
                <div class="p-8 text-center text-slate-400">
                    <i class="fas fa-bell-slash text-3xl mb-2 text-slate-300"></i>
                    <p class="text-sm">No notifications yet</p>
                </div>
            `;
        } else {
            listContainer.innerHTML = `
                <div class="p-8 text-center text-slate-400">
                    <i class="fas fa-bell text-3xl mb-2 text-slate-300"></i>
                    <p class="text-sm text-slate-500">No new notifications</p>
                </div>
            `;
        }
    }
}

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notif-badge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
                
                if (count > lastNotificationCount) {
                    badge.classList.add('animate-pulse');
                    setTimeout(() => badge.classList.remove('animate-pulse'), 2000);
                }
            } else {
                badge.classList.add('hidden');
            }
            lastNotificationCount = count;
        }

        function renderNotificationList(notifications) {
            const listContainer = document.getElementById('notification-list');
            
            if (notifications.length === 0) {
                listContainer.innerHTML = `
                    <div class="p-8 text-center text-slate-400">
                        <i class="fas fa-bell-slash text-3xl mb-2 text-slate-300"></i>
                        <p class="text-sm">No notifications yet</p>
                    </div>
                `;
                return;
            }
            
            const typeIcons = {
                'task': 'fa-check-circle text-blue-500',
                'payroll': 'fa-money-bill-wave text-green-500',
                'project': 'fa-folder-open text-purple-500',
                'system': 'fa-info-circle text-slate-500',
                'mention': 'fa-at text-amber-500'
            };
            
            const html = notifications.map(n => `
                <div class="p-4 border-b border-slate-100 hover:bg-slate-50 transition-colors cursor-pointer ${n.read ? 'opacity-60' : 'bg-blue-50/30'}" 
                     onclick="handleNotificationClick(${n.notification_id}, '${n.type}', '${(n.data || {}).action || ''}', '${(n.data || {}).entity_id || ''}')">
                    <div class="flex gap-3">
                        <div class="flex-shrink-0 mt-1">
                            <i class="fas ${typeIcons[n.type] || 'fa-bell text-slate-400'}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-slate-900 ${n.read ? 'font-normal' : ''}">${n.title}</p>
                            <p class="text-xs text-slate-600 mt-1 line-clamp-2">${n.message}</p>
                            <p class="text-xs text-slate-400 mt-1">${formatRelativeTime(n.created_at)}</p>
                        </div>
                        ${!n.read ? '<span class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"></span>' : ''}
                    </div>
                </div>
            `).join('');
            
            listContainer.innerHTML = html;
        }

         async function loadEmailSettings(container) {
  const isAdmin = currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
  
  if (!isAdmin) {
    container.innerHTML = `
      <div class="text-center py-20">
        <i class="fas fa-lock text-4xl text-slate-300 mb-4"></i>
        <p class="text-slate-500">Only administrators can configure email settings</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = `
    <div class="page-transition max-w-2xl mx-auto">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-slate-900">Email Configuration</h2>
          <p class="text-slate-500">Configure how Work Volt sends emails</p>
        </div>
      </div>
      
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
        <form id="email-config-form" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Email Provider</label>
            <select id="email-provider" onchange="updateEmailForm()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
              <option value="gmail">Gmail (Default - No setup required)</option>
              <option value="sendgrid">SendGrid</option>
              <option value="mailgun">Mailgun</option>
              <option value="smtp">Other SMTP (Limited support)</option>
            </select>
            <p class="text-xs text-slate-500 mt-1">Choose your email service provider</p>
          </div>
          
          <div id="smtp-fields" class="hidden space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">SMTP Host</label>
                <input type="text" id="smtp-host" placeholder="smtp.example.com" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Port</label>
                <input type="number" id="smtp-port" value="587" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Username / API Key</label>
              <input type="text" id="smtp-username" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Password / API Secret</label>
              <input type="password" id="smtp-password" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
              <p class="text-xs text-slate-500 mt-1">Stored encrypted in your Google Sheet</p>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">From Name</label>
              <input type="text" id="from-name" value="Work Volt" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">From Email</label>
              <input type="email" id="from-email" placeholder="noreply@workvolt.com" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
            </div>
          </div>
          
          <div class="flex items-center gap-2">
            <input type="checkbox" id="use-tls" checked class="w-4 h-4 text-blue-600 rounded">
            <label for="use-tls" class="text-sm text-slate-700">Use TLS/SSL encryption</label>
          </div>
          
          <div class="flex gap-3 pt-4">
            <button type="button" onclick="testEmailSettings()" class="flex-1 bg-amber-100 text-amber-700 py-2 rounded-lg font-medium hover:bg-amber-200">
              <i class="fas fa-vial mr-2"></i>Test Configuration
            </button>
            <button type="button" onclick="saveEmailSettings()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">
              <i class="fas fa-save mr-2"></i>Save Settings
            </button>
          </div>
        </form>
      </div>
      
      <div class="bg-blue-50 rounded-xl border border-blue-200 p-4">
        <h4 class="font-medium text-blue-900 mb-2"><i class="fas fa-info-circle mr-2"></i>Provider Setup Guides</h4>
        <div id="provider-help" class="text-sm text-blue-800 space-y-2">
          <p><strong>Gmail:</strong> Uses your Google account automatically. No configuration needed.</p>
        </div>
      </div>
    </div>
  `;
  
  // Load existing config
  try {
    const config = await apiCall('email/config');
    if (config && !config.error) {
      document.getElementById('email-provider').value = config.provider_type || 'gmail';
      document.getElementById('from-name').value = config.from_name || 'Work Volt';
      document.getElementById('from-email').value = config.from_email || '';
      if (config.smtp_host) document.getElementById('smtp-host').value = config.smtp_host;
      if (config.smtp_port) document.getElementById('smtp-port').value = config.smtp_port;
      if (config.smtp_username) document.getElementById('smtp-username').value = config.smtp_username;
      document.getElementById('use-tls').checked = config.use_tls !== false;
      updateEmailForm();
    }
  } catch (e) {
    console.log('No existing email config');
  }
}

function updateEmailForm() {
  const provider = document.getElementById('email-provider').value;
  const smtpFields = document.getElementById('smtp-fields');
  const helpDiv = document.getElementById('provider-help');
  
  const guides = {
    gmail: '<p><strong>Gmail:</strong> Uses your Google account automatically. No configuration needed. Note: Gmail has sending limits (100/day for free accounts, 1500/day for Workspace).</p>',
    sendgrid: '<p><strong>SendGrid:</strong> Enter your API Key in the Password field. Get your API key from <a href="https://app.sendgrid.com/settings/api_keys" target="_blank" class="underline">SendGrid Dashboard</a>. Leave Host/Port empty.</p>',
    mailgun: '<p><strong>Mailgun:</strong> Enter your API Key in Password field and domain (e.g., mg.yourdomain.com) in Host field. Get credentials from <a href="https://app.mailgun.com/app/account/security/api_keys" target="_blank" class="underline">Mailgun Control Panel</a>.</p>',
    smtp: '<p><strong>Custom SMTP:</strong> Limited support in Google Apps Script. Recommended providers: SendGrid, Mailgun, Amazon SES (all have HTTP APIs). For corporate SMTP, consider Google Workspace SMTP relay.</p>'
  };
  
  helpDiv.innerHTML = guides[provider] || guides.smtp;
  
  if (provider === 'gmail') {
    smtpFields.classList.add('hidden');
  } else {
    smtpFields.classList.remove('hidden');
  }
}

async function testEmailSettings() {
  const btn = event.target;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
  
  try {
    const params = {
      provider_type: document.getElementById('email-provider').value,
      smtp_host: document.getElementById('smtp-host').value,
      smtp_port: document.getElementById('smtp-port').value,
      smtp_username: document.getElementById('smtp-username').value,
      smtp_password: document.getElementById('smtp-password').value,
      from_name: document.getElementById('from-name').value,
      from_email: document.getElementById('from-email').value,
      use_tls: document.getElementById('use-tls').checked
    };
    
    const result = await apiCall('email/test', params);
    showToast(result.message || 'Test email sent! Check your inbox.', 'success');
  } catch (e) {
    showToast(e.message || 'Test failed. Check your settings.', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-vial mr-2"></i>Test Configuration';
  }
}

async function saveEmailSettings() {
  const btn = event.target;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
  
  try {
    const params = {
      provider_type: document.getElementById('email-provider').value,
      smtp_host: document.getElementById('smtp-host').value,
      smtp_port: document.getElementById('smtp-port').value,
      smtp_username: document.getElementById('smtp-username').value,
      smtp_password: document.getElementById('smtp-password').value,
      from_name: document.getElementById('from-name').value,
      from_email: document.getElementById('from-email').value,
      use_tls: document.getElementById('use-tls').checked
    };
    
    await apiCall('email/config', params);
    showToast('Email settings saved successfully');
  } catch (e) {
    showToast(e.message || 'Failed to save settings', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Settings';
  }
}   
        
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        async function handleNotificationClick(notificationId, type, action, entityId) {
            try {
                await apiCall('notifications/mark-read', {notification_id: notificationId});
                
                const data = await apiCall('notifications', {limit: 1});
                updateNotificationBadge(data.unread_count || 0);
                
                if (action === 'view_task' && entityId) {
                    showModule('tasks');
                } else if (action === 'view_payroll' && entityId) {
                    showModule('payroll');
                } else if (action === 'view_project' && entityId) {
                    showModule('projects');
                }
                
                toggleNotificationDropdown();
            } catch (e) {
                console.error('Failed to mark notification read:', e);
            }
        }

        async function markAllNotificationsRead() {
            try {
                await apiCall('notifications/mark-read', {mark_all: true});
                updateNotificationBadge(0);
                loadNotifications();
                showToast('All notifications marked as read');
            } catch (e) {
                showToast('Failed to mark notifications as read', 'error');
            }
        }

        function startNotificationPolling() {
            notificationPollingInterval = setInterval(async () => {
                if (!currentToken || !currentUser) return;
                
                try {
                    const data = await apiCall('notifications', {limit: 1});
                    updateNotificationBadge(data.unread_count || 0);
                } catch (e) {
                    console.log('Notification poll failed:', e);
                }
            }, 60000);
            
            if (currentToken && currentUser) {
                apiCall('notifications', {limit: 1}).then(data => {
                    updateNotificationBadge(data.unread_count || 0);
                }).catch(() => {});
            }
        }

            // Add loadWorkflows function
            async function loadWorkflows(container) {
              container.innerHTML = `
                <div class="page-transition">
                  <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-slate-900">Workflow Automation</h2>
          <p class="text-slate-500">Create automated rules and triggers</p>
        </div>
        <button onclick="createWorkflowForm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
          <i class="fas fa-plus mr-2"></i>New Workflow
        </button>
      </div>
      
      <div id="workflows-list" class="space-y-4">
        <div class="flex items-center justify-center h-64">
          <i class="fas fa-circle-notch fa-spin text-3xl text-blue-600"></i>
        </div>
      </div>
    </div>
  `;
  
  await loadWorkflowsData();
}

async function loadWorkflowsData() {
  try {
    const data = await apiCall('workflows');
    const workflows = data.workflows || [];
    
    if (workflows.length === 0) {
      document.getElementById('workflows-list').innerHTML = `
        <div class="text-center py-12 bg-white rounded-xl border border-slate-200">
          <i class="fas fa-robot text-4xl text-slate-300 mb-4"></i>
          <p class="text-slate-500">No workflows configured yet</p>
          <button onclick="createWorkflowForm()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">Create your first workflow</button>
        </div>
      `;
      return;
    }
    
    const triggerLabels = {
      'on_edit': 'When data changes',
      'on_form_submit': 'On form submission',
      'time_based': 'Scheduled',
      'webhook': 'External webhook'
    };
    
    const actionLabels = {
      'email': 'Send Email',
      'notification': 'In-app Notification',
      'webhook': 'Call Webhook',
      'update_sheet': 'Update Sheet',
      'create_task': 'Create Task',
      'slack': 'Slack Message'
    };
    
    const html = workflows.map(wf => `
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 ${wf.active ? '' : 'opacity-60'}">
        <div class="flex items-start justify-between mb-4">
          <div>
            <div class="flex items-center gap-2 mb-1">
              <h3 class="font-bold text-slate-900">${wf.name}</h3>
              ${wf.active ? 
                '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full">Active</span>' : 
                '<span class="px-2 py-0.5 bg-slate-100 text-slate-600 text-xs rounded-full">Paused</span>'}
            </div>
            <p class="text-sm text-slate-500">${wf.description || 'No description'}</p>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="toggleWorkflow('${wf.workflow_id}', ${!wf.active})" class="p-2 ${wf.active ? 'text-green-600 hover:bg-green-50' : 'text-slate-400 hover:bg-slate-100'} rounded-lg" title="${wf.active ? 'Pause' : 'Activate'}">
              <i class="fas ${wf.active ? 'fa-pause' : 'fa-play'}"></i>
            </button>
            <button onclick="testWorkflow('${wf.workflow_id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Test">
              <i class="fas fa-vial"></i>
            </button>
            <button onclick="editWorkflow('${wf.workflow_id}')" class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg" title="Edit">
              <i class="fas fa-pen"></i>
            </button>
            <button onclick="deleteWorkflow('${wf.workflow_id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        
        <div class="flex items-center gap-4 text-sm mb-3">
          <div class="flex items-center gap-2 text-slate-600">
            <i class="fas fa-bolt text-amber-500"></i>
            <span>${triggerLabels[wf.trigger_type] || wf.trigger_type}</span>
          </div>
          <i class="fas fa-arrow-right text-slate-300"></i>
          <div class="flex items-center gap-2 text-slate-600">
            <i class="fas fa-cog text-blue-500"></i>
            <span>${actionLabels[wf.action_type] || wf.action_type}</span>
          </div>
        </div>
        
        <div class="flex items-center justify-between text-xs text-slate-400 pt-3 border-t border-slate-100">
          <span>Runs: ${wf.run_count || 0}</span>
          <span>Last run: ${wf.last_run || 'Never'}</span>
        </div>
      </div>
    `).join('');
    
    document.getElementById('workflows-list').innerHTML = html;
  } catch (e) {
    document.getElementById('workflows-list').innerHTML = 
      `<div class="text-center py-12 text-red-500">${e.message || 'Failed to load workflows'}</div>`;
  }
}

// Add form functions similar to your other modules...
function createWorkflowForm() {
  // Implementation for workflow creation form
  showToast('Workflow creation form - implement based on your modal pattern');
}

async function toggleWorkflow(id, active) {
  try {
    await apiCall('workflows/toggle', {workflow_id: id, active: active});
    showToast(active ? 'Workflow activated' : 'Workflow paused');
    loadWorkflowsData();
  } catch (e) {
    showToast(e.message || 'Failed to toggle workflow', 'error');
  }
}

async function testWorkflow(id) {
  try {
    await apiCall('workflows/test', {workflow_id: id});
    showToast('Workflow test executed');
  } catch (e) {
    showToast(e.message || 'Test failed', 'error');
  }
}

async function deleteWorkflow(id) {
  if (!confirm('Delete this workflow?')) return;
  try {
    await apiCall('workflows', {method: 'DELETE', workflow_id: id});
    showToast('Workflow deleted');
    loadWorkflowsData();
  } catch (e) {
    showToast(e.message || 'Failed to delete', 'error');
  }
}
        
        function stopNotificationPolling() {
            if (notificationPollingInterval) {
                clearInterval(notificationPollingInterval);
                notificationPollingInterval = null;
            }
        }

        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('notification-dropdown');
            const bellBtn = e.target.closest('button');
            
            if (dropdown && !dropdown.contains(e.target) && 
                !(bellBtn && bellBtn.querySelector('.fa-bell'))) {
                dropdown.classList.add('hidden');
            }
        });

        // ==================== REPORTS MODULE (PHASE 6) ====================

let reportsCharts = {}; // Store chart instances

async function loadReports(container) {
    const isManager = currentUser.role === 'Manager' || currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
    
    if (!isManager) {
        container.innerHTML = `
            <div class="text-center py-20">
                <i class="fas fa-lock text-4xl text-slate-300 mb-4"></i>
                <p class="text-slate-500">Reports are only available to managers and administrators</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="page-transition h-full">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Reports & Analytics</h2>
                    <p class="text-slate-500">Comprehensive business insights and data visualization</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="refreshAllReports()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button onclick="exportCurrentReport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                </div>
            </div>
            
            <!-- Date Range Selector -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-1">Report Period</label>
                        <select id="report-period" onchange="updateDateRange()" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                            <option value="this_month">This Month</option>
                            <option value="last_month">Last Month</option>
                            <option value="this_quarter">This Quarter</option>
                            <option value="this_year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div id="custom-date-range" class="hidden flex gap-2">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">From</label>
                            <input type="date" id="report-date-from" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">To</label>
                            <input type="date" id="report-date-to" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                        </div>
                    </div>
                    <button onclick="loadAllReports()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                        <i class="fas fa-filter mr-1"></i>Apply
                    </button>
                </div>
            </div>
            
            <!-- Report Tabs -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 overflow-hidden">
                <div class="border-b border-slate-200">
                    <nav class="flex -mb-px">
                        <button onclick="switchReportTab('financial')" id="tab-financial" class="report-tab flex-1 py-4 px-6 text-center border-b-2 border-blue-600 text-blue-600 font-medium">
                            <i class="fas fa-chart-line mr-2"></i>Financial
                        </button>
                        <button onclick="switchReportTab('projects')" id="tab-projects" class="report-tab flex-1 py-4 px-6 text-center border-b-2 border-transparent text-slate-500 hover:text-slate-700 font-medium">
                            <i class="fas fa-folder-open mr-2"></i>Projects
                        </button>
                        <button onclick="switchReportTab('productivity')" id="tab-productivity" class="report-tab flex-1 py-4 px-6 text-center border-b-2 border-transparent text-slate-500 hover:text-slate-700 font-medium">
                            <i class="fas fa-users mr-2"></i>Productivity
                        </button>
                    </nav>
                </div>
                
                <!-- Financial Reports -->
                <div id="report-content-financial" class="report-content p-6" style="display: block;">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                            <p class="text-sm text-green-700 font-medium">Total Income</p>
                            <p id="fin-total-income" class="text-2xl font-bold text-green-700">$0.00</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-xl border border-red-200">
                            <p class="text-sm text-red-700 font-medium">Total Expenses</p>
                            <p id="fin-total-expense" class="text-2xl font-bold text-red-700">$0.00</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                            <p class="text-sm text-blue-700 font-medium">Net Profit</p>
                            <p id="fin-net-profit" class="text-2xl font-bold text-blue-700">$0.00</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-xl border border-purple-200">
                            <p class="text-sm text-purple-700 font-medium">Transactions</p>
                            <p id="fin-trans-count" class="text-2xl font-bold text-purple-700">0</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 class="font-semibold text-slate-900 mb-4">Income vs Expenses Trend</h4>
                            <div class="chart-container" style="height: 250px; position: relative;">
                                <canvas id="chart-financial-trend"></canvas>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 class="font-semibold text-slate-900 mb-4">Expense Breakdown</h4>
                            <div class="chart-container" style="height: 250px; position: relative;">
                                <canvas id="chart-expense-breakdown"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <h4 class="font-semibold text-slate-900 mb-4">Recent Transactions</h4>
                        <div class="overflow-x-auto" style="max-height: 300px; overflow-y: auto;">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-white border-b border-slate-200 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 font-medium text-slate-700">Date</th>
                                        <th class="px-4 py-2 font-medium text-slate-700">Type</th>
                                        <th class="px-4 py-2 font-medium text-slate-700">Category</th>
                                        <th class="px-4 py-2 font-medium text-slate-700 text-right">Amount</th>
                                        <th class="px-4 py-2 font-medium text-slate-700">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="fin-recent-transactions" class="divide-y divide-slate-200">
                                    <tr><td colspan="5" class="px-4 py-4 text-center text-slate-400">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Projects Reports -->
                <div id="report-content-projects" class="report-content p-6" style="display: none;">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                            <p class="text-sm text-blue-700 font-medium">Active Projects</p>
                            <p id="proj-active-count" class="text-2xl font-bold text-blue-700">0</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                            <p class="text-sm text-green-700 font-medium">Completed</p>
                            <p id="proj-completed-count" class="text-2xl font-bold text-green-700">0</p>
                        </div>
                        <div class="bg-amber-50 p-4 rounded-xl border border-amber-200">
                            <p class="text-sm text-amber-700 font-medium">Total Budget</p>
                            <p id="proj-total-budget" class="text-2xl font-bold text-amber-700">$0.00</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-xl border border-purple-200">
                            <p class="text-sm text-purple-700 font-medium">Hours Used</p>
                            <p id="proj-hours-used" class="text-2xl font-bold text-purple-700">0h</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 class="font-semibold text-slate-900 mb-4">Project Status Distribution</h4>
                            <div class="chart-container" style="height: 250px; position: relative;">
                                <canvas id="chart-project-status"></canvas>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 class="font-semibold text-slate-900 mb-4">Budget vs Hours Utilization</h4>
                            <div class="chart-container" style="height: 250px; position: relative;">
                                <canvas id="chart-project-utilization"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <h4 class="font-semibold text-slate-900 mb-4">Project Details</h4>
                        <div class="overflow-x-auto" style="max-height: 300px; overflow-y: auto;">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-white border-b border-slate-200 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 font-medium text-slate-700">Project</th>
                                        <th class="px-4 py-2 font-medium text-slate-700">Status</th>
                                        <th class="px-4 py-2 font-medium text-slate-700">Progress</th>
                                        <th class="px-4 py-2 font-medium text-slate-700 text-right">Budget</th>
                                        <th class="px-4 py-2 font-medium text-slate-700">Deadline</th>
                                    </tr>
                                </thead>
                                <tbody id="proj-details-table" class="divide-y divide-slate-200">
                                    <tr><td colspan="5" class="px-4 py-4 text-center text-slate-400">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Productivity Reports -->
                <div id="report-content-productivity" class="report-content p-6" style="display: none;">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                            <p class="text-sm text-blue-700 font-medium">Total Hours</p>
                            <p id="prod-total-hours" class="text-2xl font-bold text-blue-700">0h</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                            <p class="text-sm text-green-700 font-medium">Tasks Completed</p>
                            <p id="prod-tasks-completed" class="text-2xl font-bold text-green-700">0</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-xl border border-purple-200">
                            <p class="text-sm text-purple-700 font-medium">Avg Hours/Day</p>
                            <p id="prod-avg-hours" class="text-2xl font-bold text-purple-700">0h</p>
                        </div>
                        <div class="bg-amber-50 p-4 rounded-xl border border-amber-200">
                            <p class="text-sm text-amber-700 font-medium">Total Payroll</p>
                            <p id="prod-total-payroll" class="text-2xl font-bold text-amber-700">$0.00</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 class="font-semibold text-slate-900 mb-4">Hours by Employee</h4>
                            <div class="chart-container" style="height: 250px; position: relative;">
                                <canvas id="chart-hours-by-employee"></canvas>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 class="font-semibold text-slate-900 mb-4">Task Completion Rate</h4>
                            <div class="chart-container" style="height: 250px; position: relative;">
                                <canvas id="chart-task-completion"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <h4 class="font-semibold text-slate-900 mb-4">Employee Productivity Details</h4>
                        <div class="overflow-x-auto" style="max-height: 300px; overflow-y: auto;">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-white border-b border-slate-200 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 font-medium text-slate-700">Employee</th>
                                        <th class="px-4 py-2 font-medium text-slate-700">Role</th>
                                        <th class="text-right px-4 py-2 font-medium text-slate-700">Hours</th>
                                        <th class="text-right px-4 py-2 font-medium text-slate-700">Tasks</th>
                                        <th class="text-right px-4 py-2 font-medium text-slate-700">Avg/Day</th>
                                        <th class="text-right px-4 py-2 font-medium text-slate-700">Payroll</th>
                                    </tr>
                                </thead>
                                <tbody id="prod-employee-table" class="divide-y divide-slate-200">
                                    <tr><td colspan="6" class="px-4 py-4 text-center text-slate-400">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Set default dates
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    document.getElementById('report-date-from').value = firstDay.toISOString().split('T')[0];
    document.getElementById('report-date-to').value = today.toISOString().split('T')[0];
    
    // Initialize current tab
    window.currentReportTab = 'financial';
    
    await loadAllReports();
}

function updateDateRange() {
    const period = document.getElementById('report-period').value;
    const customRange = document.getElementById('custom-date-range');
    
    if (period === 'custom') {
        customRange.classList.remove('hidden');
    } else {
        customRange.classList.add('hidden');
        const today = new Date();
        let from = new Date();
        
        switch(period) {
            case 'this_month':
                from = new Date(today.getFullYear(), today.getMonth(), 1);
                break;
            case 'last_month':
                from = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                today.setDate(0);
                break;
            case 'this_quarter':
                const quarter = Math.floor(today.getMonth() / 3);
                from = new Date(today.getFullYear(), quarter * 3, 1);
                break;
            case 'this_year':
                from = new Date(today.getFullYear(), 0, 1);
                break;
        }
        
        document.getElementById('report-date-from').value = from.toISOString().split('T')[0];
        document.getElementById('report-date-to').value = today.toISOString().split('T')[0];
    }
}

function switchReportTab(tab) {
    // Update tab styles
    document.querySelectorAll('.report-tab').forEach(t => {
        t.classList.remove('border-blue-600', 'text-blue-600');
        t.classList.add('border-transparent', 'text-slate-500');
    });
    document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-slate-500');
    document.getElementById(`tab-${tab}`).classList.add('border-blue-600', 'text-blue-600');
    
    // Show/hide content using display none/block instead of hidden class
    document.querySelectorAll('.report-content').forEach(c => {
        c.style.display = 'none';
    });
    document.getElementById(`report-content-${tab}`).style.display = 'block';
    
    // Store current tab for export
    window.currentReportTab = tab;
    
    // Resize charts if they exist to prevent canvas expansion
    Object.values(reportsCharts).forEach(chart => {
        if (chart && typeof chart.resize === 'function') {
            chart.resize();
        }
    });
}

async function loadAllReports() {
    const dateFrom = document.getElementById('report-date-from').value;
    const dateTo = document.getElementById('report-date-to').value;
    
    await Promise.all([
        loadFinancialReport(dateFrom, dateTo),
        loadProjectsReport(),
        loadProductivityReport(dateFrom, dateTo)
    ]);
}

async function loadFinancialReport(dateFrom, dateTo) {
    try {
        const data = await apiCall('reports/financial', {date_from: dateFrom, date_to: dateTo});
        
        // Update summary cards
        document.getElementById('fin-total-income').textContent = '$' + (data.summary.total_income || 0).toFixed(2);
        document.getElementById('fin-total-expense').textContent = '$' + (data.summary.total_expense || 0).toFixed(2);
        document.getElementById('fin-net-profit').textContent = '$' + (data.summary.net_profit || 0).toFixed(2);
        document.getElementById('fin-trans-count').textContent = data.summary.transaction_count || 0;
        
        // Trend Chart
        const trendCtx = document.getElementById('chart-financial-trend').getContext('2d');
        if (reportsCharts.trend) reportsCharts.trend.destroy();
        
        const months = data.monthly_trend.map(m => {
            const [year, month] = m.month.split('-');
            return new Date(year, month - 1).toLocaleDateString('en-US', {month: 'short', year: '2-digit'});
        });
        
        reportsCharts.trend = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Income',
                    data: data.monthly_trend.map(m => m.income),
                    borderColor: '#16a34a',
                    backgroundColor: 'rgba(22, 163, 74, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Expenses',
                    data: data.monthly_trend.map(m => m.expense),
                    borderColor: '#dc2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {intersect: false, mode: 'index'},
                plugins: {
                    legend: {position: 'bottom'}
                },
                scales: {
                    y: {beginAtZero: true, ticks: {callback: v => '$' + v}}
                }
            }
        });
        
        // Expense Breakdown Pie Chart
        const expenseCtx = document.getElementById('chart-expense-breakdown').getContext('2d');
        if (reportsCharts.expensePie) reportsCharts.expensePie.destroy();
        
        reportsCharts.expensePie = new Chart(expenseCtx, {
            type: 'doughnut',
            data: {
                labels: data.categories.expense.map(c => c.name),
                datasets: [{
                    data: data.categories.expense.map(c => c.value),
                    backgroundColor: [
                        '#3b82f6', '#ef4444', '#10b981', '#f59e0b', 
                        '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {position: 'bottom', labels: {boxWidth: 12}}
                }
            }
        });
        
        // Recent Transactions Table
        const rows = data.transactions.slice(0, 10).map(t => `
            <tr class="hover:bg-white">
                <td class="px-4 py-2 text-slate-900">${t.date}</td>
                <td class="px-4 py-2">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${t.type === 'income' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                        ${t.type}
                    </span>
                </td>
                <td class="px-4 py-2 text-slate-600 capitalize">${t.category}</td>
                <td class="px-4 py-2 text-right font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                    ${t.type === 'income' ? '+' : '-'}$${(t.amount || 0).toFixed(2)}
                </td>
                <td class="px-4 py-2">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${t.status === 'paid' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">
                        ${t.status}
                    </span>
                </td>
            </tr>
        `).join('');
        
        document.getElementById('fin-recent-transactions').innerHTML = rows || 
            '<tr><td colspan="5" class="px-4 py-4 text-center text-slate-400">No transactions found</td></tr>';
            
    } catch (e) {
        showToast('Failed to load financial report: ' + e.message, 'error');
    }
}

async function loadProjectsReport() {
    try {
        const data = await apiCall('reports/projects');
        
        // Update summary cards
        document.getElementById('proj-active-count').textContent = data.summary.status_breakdown.active || 0;
        document.getElementById('proj-completed-count').textContent = data.summary.status_breakdown.completed || 0;
        document.getElementById('proj-total-budget').textContent = '$' + (data.summary.total_budget || 0).toFixed(2);
        document.getElementById('proj-hours-used').textContent = (data.summary.total_hours_used || 0).toFixed(1) + 'h';
        
        // Status Distribution Chart
        const statusCtx = document.getElementById('chart-project-status').getContext('2d');
        if (reportsCharts.projectStatus) reportsCharts.projectStatus.destroy();
        
        reportsCharts.projectStatus = new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(data.summary.status_breakdown).map(s => s.charAt(0).toUpperCase() + s.slice(1)),
                datasets: [{
                    data: Object.values(data.summary.status_breakdown),
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {position: 'bottom'}
                }
            }
        });
        
        // Utilization Chart (Hours vs Budget)
        const utilCtx = document.getElementById('chart-project-utilization').getContext('2d');
        if (reportsCharts.utilization) reportsCharts.utilization.destroy();
        
        const activeProjects = data.projects.filter(p => p.status === 'active').slice(0, 6);
        
        reportsCharts.utilization = new Chart(utilCtx, {
            type: 'bar',
            data: {
                labels: activeProjects.map(p => p.name.substring(0, 15) + (p.name.length > 15 ? '...' : '')),
                datasets: [{
                    label: 'Hours Used %',
                    data: activeProjects.map(p => p.hours_progress),
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                }, {
                    label: 'Task Progress %',
                    data: activeProjects.map(p => p.progress),
                    backgroundColor: '#10b981',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {position: 'bottom'}
                },
                scales: {
                    y: {beginAtZero: true, max: 100, ticks: {callback: v => v + '%'}}
                }
            }
        });
        
        // Projects Table
        const rows = data.projects.map(p => `
            <tr class="hover:bg-white ${p.is_overdue ? 'bg-red-50' : ''}">
                <td class="px-4 py-2 font-medium text-slate-900">${p.name}</td>
                <td class="px-4 py-2">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${
                        p.status === 'active' ? 'bg-blue-100 text-blue-700' :
                        p.status === 'completed' ? 'bg-green-100 text-green-700' :
                        p.status === 'on-hold' ? 'bg-amber-100 text-amber-700' :
                        'bg-red-100 text-red-700'
                    }">${p.status}</span>
                </td>
                <td class="px-4 py-2">
                    <div class="flex items-center gap-2">
                        <div class="flex-1 bg-slate-200 rounded-full h-2 w-24">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${p.progress}%"></div>
                        </div>
                        <span class="text-xs text-slate-600">${p.progress}%</span>
                    </div>
                </td>
                <td class="px-4 py-2 text-right text-slate-900">$${(p.budget || 0).toFixed(2)}</td>
                <td class="px-4 py-2 text-slate-600">
                    ${p.is_overdue ? 
                        `<span class="text-red-600 font-medium">${p.days_remaining}d overdue</span>` :
                        p.days_remaining !== null ? 
                            (p.days_remaining < 7 ? 
                                `<span class="text-amber-600">${p.days_remaining}d left</span>` :
                                `${p.days_remaining}d left`) :
                        '-'
                    }
                </td>
            </tr>
        `).join('');
        
        document.getElementById('proj-details-table').innerHTML = rows || 
            '<tr><td colspan="5" class="px-4 py-4 text-center text-slate-400">No projects found</td></tr>';
            
    } catch (e) {
        showToast('Failed to load projects report: ' + e.message, 'error');
    }
}

async function loadProductivityReport(dateFrom, dateTo) {
    try {
        const data = await apiCall('reports/productivity', {date_from: dateFrom, date_to: dateTo});
        
        // Update summary cards
        document.getElementById('prod-total-hours').textContent = (data.summary.total_hours || 0).toFixed(1) + 'h';
        document.getElementById('prod-tasks-completed').textContent = data.summary.total_tasks_completed || 0;
        document.getElementById('prod-avg-hours').textContent = (data.summary.avg_productivity || 0).toFixed(1) + 'h';
        document.getElementById('prod-total-payroll').textContent = '$' + (data.summary.total_payroll || 0).toFixed(2);
        
        // Hours by Employee Chart
        const hoursCtx = document.getElementById('chart-hours-by-employee').getContext('2d');
        if (reportsCharts.hoursByEmployee) reportsCharts.hoursByEmployee.destroy();
        
        const topEmployees = data.employees.slice(0, 8);
        
        reportsCharts.hoursByEmployee = new Chart(hoursCtx, {
            type: 'bar',
            data: {
                labels: topEmployees.map(e => e.name.split(' ')[0]),
                datasets: [{
                    label: 'Hours Logged',
                    data: topEmployees.map(e => e.total_hours),
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {display: false}
                },
                scales: {
                    y: {beginAtZero: true}
                }
            }
        });
        
        // Task Completion Chart
        const taskCtx = document.getElementById('chart-task-completion').getContext('2d');
        if (reportsCharts.taskCompletion) reportsCharts.taskCompletion.destroy();
        
        reportsCharts.taskCompletion = new Chart(taskCtx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'In Progress'],
                datasets: [{
                    data: [
                        data.summary.total_tasks_completed,
                        data.employees.reduce((sum, e) => sum + e.tasks_in_progress, 0)
                    ],
                    backgroundColor: ['#10b981', '#f59e0b']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {position: 'bottom'}
                }
            }
        });
        
        // Employee Table
        const rows = data.employees.map(e => `
            <tr class="hover:bg-white">
                <td class="px-4 py-2">
                    <div class="font-medium text-slate-900">${e.name}</div>
                    <div class="text-xs text-slate-500">${e.department || 'No department'}</div>
                </td>
                <td class="px-4 py-2">
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600">
                        ${e.role}
                    </span>
                </td>
                <td class="px-4 py-2 text-right font-bold text-blue-600">${e.total_hours.toFixed(1)}h</td>
                <td class="px-4 py-2 text-right text-slate-900">${e.tasks_completed}</td>
                <td class="px-4 py-2 text-right text-slate-600">${e.avg_hours_per_day.toFixed(1)}h</td>
                <td class="px-4 py-2 text-right font-medium text-slate-900">$${e.payroll_total.toFixed(2)}</td>
            </tr>
        `).join('');
        
        document.getElementById('prod-employee-table').innerHTML = rows || 
            '<tr><td colspan="6" class="px-4 py-4 text-center text-slate-400">No data found</td></tr>';
            
    } catch (e) {
        showToast('Failed to load productivity report: ' + e.message, 'error');
    }
}

function refreshAllReports() {
    loadAllReports();
    showToast('Reports refreshed');
}

async function exportCurrentReport() {
    const tab = window.currentReportTab || 'financial';
    const dateFrom = document.getElementById('report-date-from').value;
    const dateTo = document.getElementById('report-date-to').value;
    
    try {
        showToast('Generating CSV export...', 'info');
        
        // Use the existing API with CSV format
        const url = new URL(API_URL);
        url.searchParams.append('path', 'reports/export');
        url.searchParams.append('token', currentToken);
        url.searchParams.append('report_type', tab === 'financial' ? 'financial' : tab === 'productivity' ? 'timesheets' : 'projects');
        url.searchParams.append('format', 'csv');
        url.searchParams.append('date_from', dateFrom);
        url.searchParams.append('date_to', dateTo);
        
        window.open(url.toString(), '_blank');
        
    } catch (e) {
        showToast('Export failed: ' + e.message, 'error');
    }
}
        
        // ==================== END NOTIFICATION SYSTEM ====================

        // Initialize on load
        window.onload = () => {
            if(currentToken) {
                const savedUser = localStorage.getItem('workvolt_user');
                if(savedUser) {
                    try {
                        currentUser = JSON.parse(savedUser);
                        apiCall('users/me').then(() => {
                            showApp();
                        }).catch(err => {
                            localStorage.removeItem('workvolt_token');
                            localStorage.removeItem('workvolt_user');
                            currentToken = null;
                            currentUser = null;
                        });
                    } catch(e) {
                        localStorage.removeItem('workvolt_token');
                        localStorage.removeItem('workvolt_user');
                    }
                }
            }
        };
    </script>
</body>
</html>
