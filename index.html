<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Volt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .kanban-scroll::-webkit-scrollbar { height: 8px; }
        .kanban-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .kanban-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .sortable-ghost { opacity: 0.4; background: #e2e8f0; border: 2px dashed #94a3b8; }
        .sortable-drag { cursor: grabbing; transform: rotate(2deg); }
        .widget { transition: all 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .page-transition { animation: fadeIn 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loading-skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @media (max-width: 768px) {
            .kanban-container { flex-direction: column; }
            .kanban-column { width: 100% !important; margin-bottom: 1rem; }
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">
    <!-- Loading Overlay -->
    <div id="global-loading" class="hidden fixed inset-0 bg-white/80 z-50 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600 mb-2"></i>
            <p class="text-slate-600">Loading...</p>
        </div>
    </div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-xl mb-4">
                    <i class="fas fa-bolt text-3xl text-blue-600"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-900">Work Volt</h1>
                <p class="text-slate-500 mt-2">Power your operations</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="login-email" value="admin@workvolt.com" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                    <input type="password" id="login-password" value="password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div id="login-error" class="hidden text-red-600 text-sm bg-red-50 p-2 rounded"></div>
                <button type="submit" id="login-btn" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                    <span id="login-btn-text">Sign In</span>
                    <i id="login-btn-spinner" class="fas fa-spinner fa-spin hidden"></i>
                </button>
            </form>
        </div>
    </div>

    <div id="app-screen" class="hidden min-h-screen flex flex-col">
        <header class="bg-white border-b border-slate-200 sticky top-0 z-40">
            <div class="flex items-center justify-between px-4 py-3">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 hover:bg-slate-100 rounded-lg"><i class="fas fa-bars text-slate-600"></i></button>
                    <div class="flex items-center gap-2 cursor-pointer" onclick="showModule('dashboard')">
                        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center"><i class="fas fa-bolt text-white text-sm"></i></div>
                        <span class="text-xl font-bold text-slate-900">Work Volt</span>
                    </div>
                </div>
                <div class="flex-1 max-w-xl mx-4 hidden md:block">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" placeholder="Search..." class="w-full pl-10 pr-4 py-2 bg-slate-100 border-0 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button class="relative p-2 hover:bg-slate-100 rounded-lg"><i class="fas fa-bell text-slate-600"></i><span id="notif-badge" class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full hidden"></span></button>
                    <div class="flex items-center gap-2 pl-3 border-l border-slate-200">
                        <div id="user-avatar" class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-medium text-sm">JD</div>
                        <span id="user-name" class="hidden md:block text-sm font-medium text-slate-700">John Doe</span>
                        <button onclick="logout()" class="ml-2 p-2 hover:bg-slate-100 rounded-lg text-slate-500" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <aside id="sidebar" class="w-64 bg-white border-r border-slate-200 flex-shrink-0 hidden lg:flex flex-col">
                <nav class="flex-1 overflow-y-auto p-4 space-y-1" id="nav-menu"></nav>
            </aside>
            <main class="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-6" id="main-content"></main>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwY-oCLRpuxl8ghe-avGACVid5F2WPqE01V1P5s42QJFjl0U6RA2WBJ1M6SNWMOkOMz/exec';
        let currentUser = null;
        let currentToken = localStorage.getItem('workvolt_token');
        let dashboardSortable = null;
        let allUsers = [];
        let cache = {
            tasks: null,
            users: null,
            payroll: null,
            timesheets: null,
            lastFetch: {}
        };

        // Cache helper
        function getCached(key, maxAge = 30000) {
            const cached = cache[key];
            const lastFetch = cache.lastFetch[key];
            if (cached && lastFetch && (Date.now() - lastFetch) < maxAge) {
                return cached;
            }
            return null;
        }

        function setCached(key, data) {
            cache[key] = data;
            cache.lastFetch[key] = Date.now();
        }

        function clearCache() {
            cache = { tasks: null, users: null, payroll: null, timesheets: null, lastFetch: {} };
        }

        async function apiCall(path, params = {}, retries = 2) {
            const url = new URL(API_URL);
            url.searchParams.append('path', path);
            if(currentToken) url.searchParams.append('token', currentToken);
            for(let key in params) {
                if(params[key] !== undefined && params[key] !== null) url.searchParams.append(key, params[key]);
            }
            
            let lastError;
            for(let i = 0; i <= retries; i++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                    
                    const response = await fetch(url.toString(), {
                        method: 'GET', 
                        mode: 'cors', 
                        cache: 'no-cache',
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if(!response.ok) throw new Error('HTTP ' + response.status);
                    const text = await response.text();
                    if(!text || text.trim() === '') throw new Error('Empty response');
                    
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch(e) {
                        throw new Error('Invalid JSON: ' + text.substring(0, 100));
                    }
                    
                    if(data.error) throw new Error(data.error);
                    return data;
                } catch(err) {
                    lastError = err;
                    if(err.name === 'AbortError') {
                        lastError = new Error('Request timeout - please try again');
                    }
                    if(err.message === 'Unauthorized' || err.message === 'TOKEN_INVALID') {
                        localStorage.removeItem('workvolt_token');
                        localStorage.removeItem('workvolt_user');
                        currentToken = null;
                        currentUser = null;
                        document.getElementById('app-screen').classList.add('hidden');
                        document.getElementById('login-screen').classList.remove('hidden');
                        showToast('Session expired. Please log in again.', 'error');
                        throw new Error('Session expired');
                    }
                    if(i < retries) await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
            throw lastError || new Error('Network error - please refresh');
        }

        // Login with timeout protection
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            const btnText = document.getElementById('login-btn-text');
            const btnSpinner = document.getElementById('login-btn-spinner');
            const errorDiv = document.getElementById('login-error');
            
            // Reset state
            btn.disabled = true;
            btnText.classList.add('hidden');
            btnSpinner.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            
            // Set timeout to reset button if stuck
            const timeoutId = setTimeout(() => {
                btn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
                errorDiv.textContent = 'Login timed out. Please try again.';
                errorDiv.classList.remove('hidden');
            }, 15000);
            
            try {
                const data = await apiCall('auth/login', {email, password}, 1);
                clearTimeout(timeoutId);
                
                currentToken = data.token;
                currentUser = data.user;
                localStorage.setItem('workvolt_token', currentToken);
                localStorage.setItem('workvolt_user', JSON.stringify(currentUser));
                
                // Reset button
                btn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
                
                showApp();
            } catch(err) {
                clearTimeout(timeoutId);
                btn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
                errorDiv.textContent = err.message || 'Login failed. Please try again.';
                errorDiv.classList.remove('hidden');
            }
        });

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-avatar').textContent = currentUser.name.split(' ').map(n => n[0]).join('').slice(0,2);
            renderNav();
            
            // Restore last module or default to dashboard
            const lastModule = sessionStorage.getItem('lastModule') || 'dashboard';
            showModule(lastModule);
        }
        
        function logout() {
            clearCache();
            localStorage.removeItem('workvolt_token');
            localStorage.removeItem('workvolt_user');
            sessionStorage.removeItem('lastModule');
            currentToken = null;
            currentUser = null;
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
        }

        const modules = {
            SuperAdmin: ['dashboard', 'tasks', 'pipeline', 'payroll', 'timesheets', 'financials'],
            Admin: ['dashboard', 'tasks', 'pipeline', 'payroll', 'timesheets', 'financials'],
            Manager: ['dashboard', 'tasks', 'pipeline', 'payroll', 'timesheets', 'financials'],
            Employee: ['dashboard', 'tasks', 'payroll', 'timesheets'],
            Contractor: ['dashboard', 'tasks', 'payroll', 'timesheets']
        };

        const moduleIcons = {
            dashboard: 'fa-grid-2', 
            tasks: 'fa-check-circle', 
            pipeline: 'fa-users', 
            payroll: 'fa-money-bill', 
            timesheets: 'fa-clock',
            financials: 'fa-chart-line'
        };

        function renderNav() {
            const nav = document.getElementById('nav-menu');
            const allowed = modules[currentUser.role] || modules.Employee;
            nav.innerHTML = allowed.map(mod => `
                <a href="#" onclick="showModule('${mod}'); return false;" class="nav-item flex items-center gap-3 px-3 py-2 text-slate-600 hover:bg-slate-50 rounded-lg font-medium transition-colors" data-module="${mod}">
                    <i class="fas ${moduleIcons[mod]} w-5"></i> ${mod.charAt(0).toUpperCase() + mod.slice(1)}
                </a>
            `).join('');
        }

        function showModule(moduleName) {
            // Save current module for refresh recovery
            sessionStorage.setItem('lastModule', moduleName);
            
            // Update nav highlighting
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('bg-blue-50', 'text-blue-700');
                n.classList.add('text-slate-600');
            });
            const navItem = document.querySelector(`[data-module="${moduleName}"]`);
            if(navItem) {
                navItem.classList.add('bg-blue-50', 'text-blue-700');
                navItem.classList.remove('text-slate-600');
            }
            
            // Show loading
            const main = document.getElementById('main-content');
            main.innerHTML = '<div class="flex items-center justify-center h-64"><i class="fas fa-circle-notch fa-spin text-3xl text-blue-600"></i></div>';
            
            // Small delay to allow UI to update
            setTimeout(() => {
                        switch(moduleName) {
                            case 'dashboard': loadDashboard(main); break;
                            case 'tasks': loadTasks(main); break;
                            case 'pipeline': loadPipeline(main); break;
                            case 'payroll': loadPayroll(main); break;
                            case 'timesheets': loadTimesheets(main); break;
                            case 'financials': loadFinancials(main); break;
                            default: main.innerHTML = '<div class="text-center py-20 text-slate-400">Module coming soon</div>';
                }
            }, 50);
        }

        async function loadDashboard(container) {
            container.innerHTML = `
                <div class="page-transition">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Dashboard</h2>
                            <p class="text-slate-500">Welcome back, ${currentUser.name}</p>
                        </div>
                        <button onclick="toggleEditMode()" id="edit-btn" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50">
                            <i class="fas fa-pen mr-2"></i>Customize
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="dashboard-grid">
                        ${renderWidget('my-tasks', 'My Tasks', 'col-span-1 row-span-2')}
                        ${renderWidget('stats', 'Quick Stats', '')}
                        ${renderWidget('pipeline', 'Hiring', '')}
                    </div>
                </div>
            `;
            
            dashboardSortable = new Sortable(document.getElementById('dashboard-grid'), {
                animation: 150, handle: '.widget-handle', ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', disabled: true, onEnd: saveDashboardLayout
            });
            
            // Load data in parallel
            await loadAllWidgetData();
        }

        function renderWidget(type, title, classes) {
            return `
                <div class="widget bg-white rounded-xl shadow-sm border border-slate-200 p-4 ${classes}" data-widget="${type}">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-slate-900">${title}</h3>
                        <i class="fas fa-grip-vertical text-slate-400 widget-handle hidden cursor-move"></i>
                    </div>
                    <div class="widget-content" id="widget-${type}">
                        <div class="animate-pulse space-y-3">
                            <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                            <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadAllWidgetData() {
            try {
                // Use cached tasks if available
                let tasks = getCached('tasks');
                if (!tasks) {
                    const tasksData = await apiCall('tasks', {assignee: currentUser.user_id});
                    tasks = tasksData.tasks || [];
                    setCached('tasks', tasks);
                }
                
                // My Tasks Widget
                const myTasksHtml = tasks.filter(t => t.status !== 'Done').slice(0, 5).map(t => `
                    <div class="flex items-start gap-3 p-3 bg-slate-50 rounded-lg border-l-4 ${getPriorityColor(t.priority)} mb-2 cursor-pointer hover:bg-slate-100" onclick="showModule('tasks')">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-slate-900 line-clamp-1">${t.title}</p>
                            <p class="text-xs text-slate-500 mt-1">${t.due_date || 'No due date'} ${t.actual_hours > 0 ? `• ${t.actual_hours}h logged` : ''}</p>
                        </div>
                    </div>
                `).join('') || '<p class="text-sm text-slate-400">No pending tasks</p>';
                document.getElementById('widget-my-tasks').innerHTML = myTasksHtml;

                // Stats Widget
                const todoCount = tasks.filter(t => t.status === 'Todo').length;
                const inProgressCount = tasks.filter(t => t.status === 'In Progress').length;
                const doneCount = tasks.filter(t => t.status === 'Done').length;
                document.getElementById('widget-stats').innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-3 bg-blue-50 rounded-lg cursor-pointer hover:bg-blue-100" onclick="showModule('tasks')">
                            <p class="text-2xl font-bold text-blue-600">${tasks.length}</p>
                            <p class="text-xs text-blue-700 font-medium">Total Tasks</p>
                        </div>
                        <div class="text-center p-3 bg-amber-50 rounded-lg cursor-pointer hover:bg-amber-100" onclick="showModule('tasks')">
                            <p class="text-2xl font-bold text-amber-600">${inProgressCount}</p>
                            <p class="text-xs text-amber-700 font-medium">In Progress</p>
                        </div>
                        <div class="text-center p-3 bg-green-50 rounded-lg cursor-pointer hover:bg-green-100" onclick="showModule('tasks')">
                            <p class="text-2xl font-bold text-green-600">${doneCount}</p>
                            <p class="text-xs text-green-700 font-medium">Completed</p>
                        </div>
                        <div class="text-center p-3 bg-purple-50 rounded-lg cursor-pointer hover:bg-purple-100" onclick="showModule('tasks')">
                            <p class="text-2xl font-bold text-purple-600">${todoCount}</p>
                            <p class="text-xs text-purple-700 font-medium">To Do</p>
                        </div>
                    </div>
                `;
            } catch(e) {
                document.getElementById('widget-my-tasks').innerHTML = '<p class="text-sm text-slate-400">Unable to load tasks</p>';
                document.getElementById('widget-stats').innerHTML = '<p class="text-sm text-slate-400">Unable to load stats</p>';
            }
            
            try {
                const pipeData = await apiCall('pipeline');
                const candidates = pipeData.candidates || [];
                const stages = ['Applied', 'Screening', 'Interview', 'Offer', 'Hired'];
                const stageCounts = {};
                stages.forEach(s => stageCounts[s] = candidates.filter(c => c.stage === s).length);
                document.getElementById('widget-pipeline').innerHTML = `
                    <div class="flex gap-2 overflow-x-auto pb-2 cursor-pointer" onclick="showModule('pipeline')">
                        ${stages.map(stage => `
                            <div class="flex-shrink-0 w-20 p-3 ${stage === 'Hired' ? 'bg-green-50' : 'bg-slate-50'} rounded-lg text-center hover:bg-opacity-80">
                                <p class="text-xl font-bold ${stage === 'Hired' ? 'text-green-600' : 'text-slate-700'}">${stageCounts[stage]}</p>
                                <p class="text-xs ${stage === 'Hired' ? 'text-green-600' : 'text-slate-500'}">${stage}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch(e) {
                document.getElementById('widget-pipeline').innerHTML = '<p class="text-sm text-slate-400">Unable to load pipeline</p>';
            }
        }

        function toggleEditMode() {
            const btn = document.getElementById('edit-btn');
            const isEditing = btn.classList.contains('bg-blue-600');
            if(isEditing) {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-white', 'text-slate-700');
                btn.innerHTML = '<i class="fas fa-pen mr-2"></i>Customize';
                document.querySelectorAll('.widget-handle').forEach(h => h.classList.add('hidden'));
                dashboardSortable.option("disabled", true);
            } else {
                btn.classList.remove('bg-white', 'text-slate-700');
                btn.classList.add('bg-blue-600', 'text-white');
                btn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Layout';
                document.querySelectorAll('.widget-handle').forEach(h => h.classList.remove('hidden'));
                dashboardSortable.option("disabled", false);
            }
        }

        async function saveDashboardLayout() {
            const widgets = [];
            document.querySelectorAll('.widget').forEach((w, i) => widgets.push({type: w.dataset.widget, index: i}));
            try {
                await apiCall('users/dashboard', {layout: JSON.stringify(widgets)});
                showToast('Layout saved');
            } catch(e) {
                showToast(e.message || 'Save failed', 'error');
            }
        }

        function getPriorityColor(p) {
            return {Urgent: 'border-red-500', High: 'border-amber-500', Medium: 'border-blue-500', Low: 'border-slate-300'}[p] || 'border-slate-300';
        }

        async function loadTasks(container) {
            container.innerHTML = `
                <div class="page-transition">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Tasks</h2>
                            <p class="text-slate-500">Drag cards to change status</p>
                        </div>
                        <button onclick="createTask()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>New Task
                        </button>
                    </div>
                    <div class="flex gap-6 overflow-x-auto kanban-scroll pb-4" id="task-board">
                        ${renderKanbanColumn('Backlog', 'bg-slate-400')}
                        ${renderKanbanColumn('Todo', 'bg-blue-400')}
                        ${renderKanbanColumn('In Progress', 'bg-amber-400')}
                        ${renderKanbanColumn('Review', 'bg-purple-400')}
                        ${renderKanbanColumn('Done', 'bg-green-400')}
                    </div>
                </div>
            `;
            
            try {
                // Use cache or fetch
                let tasks = getCached('tasks');
                if (!tasks) {
                    const data = await apiCall('tasks');
                    tasks = data.tasks || [];
                    setCached('tasks', tasks);
                }
                
                // Clear and populate columns
                ['Backlog', 'Todo', 'In-Progress', 'Review', 'Done'].forEach(status => {
                    const col = document.getElementById(`col-${status}`);
                    if(col) col.innerHTML = '';
                });
                
                tasks.forEach(task => {
                    const col = document.getElementById(`col-${task.status.replace(' ', '-')}`);
                    if(col) col.innerHTML += renderTaskCard(task);
                });
                
                // Initialize sortable
                ['Backlog', 'Todo', 'In-Progress', 'Review', 'Done'].forEach(status => {
                    new Sortable(document.getElementById(`col-${status}`), {
                        group: 'tasks', animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', delay: 100, delayOnTouchOnly: true,
                        onEnd: async function(evt) {
                            const taskId = evt.item.dataset.taskId;
                            const newStatus = evt.to.dataset.status;
                            const oldStatus = evt.from.dataset.status;
                            if(newStatus !== oldStatus) {
                                evt.item.style.opacity = '0.5';
                                try {
                                    await apiCall('tasks/move', {task_id: taskId, to_status: newStatus});
                                    evt.item.style.opacity = '1';
                                    clearCache(); // Clear cache on change
                                    showToast(`Moved to ${newStatus}`);
                                } catch(e) {
                                    evt.from.appendChild(evt.item);
                                    evt.item.style.opacity = '1';
                                    showToast(e.message || 'Failed to move', 'error');
                                }
                            }
                        }
                    });
                });
            } catch(e) {
                container.innerHTML += `<div class="text-red-500 mt-4">${e.message || 'Failed to load tasks'}</div>`;
            }
        }

        function renderKanbanColumn(status, colorClass) {
            const statusId = status.replace(' ', '-');
            return `
                <div class="flex-shrink-0 w-80">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-slate-700 flex items-center gap-2">
                            <span class="w-2 h-2 ${colorClass} rounded-full"></span>${status}
                        </h3>
                    </div>
                    <div class="space-y-3 min-h-[200px] bg-slate-100/50 rounded-xl p-2" id="col-${statusId}" data-status="${status}"></div>
                </div>
            `;
        }

        function renderTaskCard(task) {
            const hoursDisplay = task.actual_hours > 0 ? 
                `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${task.actual_hours}h</span>` : '';
            
            const payDisplay = task.pay_per_task > 0 ? 
                `<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">$${task.pay_per_task}</span>` : '';
            
            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 card-hover cursor-move mb-2" data-task-id="${task.task_id}">
                    <div class="flex items-start justify-between mb-2">
                        <span class="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded">Task</span>
                        <span class="text-xs ${task.priority === 'Urgent' ? 'text-red-600 font-bold' : 'text-slate-400'}">${task.priority}</span>
                    </div>
                    <h4 class="font-medium text-slate-900 mb-2 text-sm line-clamp-2">${task.title}</h4>
                    <div class="flex items-center justify-between text-xs text-slate-500 mb-2">
                        <span>${task.due_date || 'No date'}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex gap-1">
                            ${hoursDisplay}
                            ${payDisplay}
                        </div>
                        <button onclick="event.stopPropagation(); quickLogHours(${task.task_id})" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 transition-colors">
                            <i class="fas fa-clock mr-1"></i>Log
                        </button>
                    </div>
                </div>
            `;
        }

        async function quickLogHours(taskId) {
            try {
                // Get fresh task data or use cache
                let tasks = getCached('tasks');
                if (!tasks) {
                    const tasksData = await apiCall('tasks', {assignee: currentUser.user_id});
                    tasks = tasksData.tasks || [];
                }
                
                const task = tasks.find(t => t.task_id == taskId);
                if (!task) {
                    showToast('Task not found', 'error');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.id = 'log-hours-modal';
                modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-slate-900 mb-1">Log Hours</h3>
                            <p class="text-sm text-slate-500 mb-4">${task.title}</p>
                            <div class="space-y-4">
                                <input type="hidden" id="lh-task" value="${taskId}">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
                                        <input type="date" id="lh-date" value="${new Date().toISOString().split('T')[0]}" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Hours</label>
                                        <input type="number" id="lh-hours" step="0.25" min="0.25" max="24" placeholder="0.00" class="w-full px-3 py-2 border border-slate-300 rounded-lg" autofocus>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Notes (Optional)</label>
                                    <textarea id="lh-notes" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="What did you work on?"></textarea>
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="submitLogHours()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">Log Hours</button>
                                <button onclick="closeLogHoursModal()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('lh-hours').focus();
            } catch (e) {
                showToast('Failed to load task details', 'error');
            }
        }

        function closeLogHoursModal() {
            document.getElementById('log-hours-modal')?.remove();
        }

        async function submitLogHours() {
            const taskId = document.getElementById('lh-task').value;
            const date = document.getElementById('lh-date').value;
            const hours = parseFloat(document.getElementById('lh-hours').value);
            const notes = document.getElementById('lh-notes').value;
            
            if (!taskId) {
                showToast('Please select a task', 'error');
                return;
            }
            if (!hours || hours <= 0) {
                showToast('Please enter valid hours', 'error');
                return;
            }
            
            try {
                await apiCall('timesheets', {
                    method: 'POST',
                    task_id: taskId,
                    date: date,
                    hours: hours,
                    notes: notes
                }, 0);
                
                closeLogHoursModal();
                clearCache(); // Clear cache to reflect new hours
                showToast(`Logged ${hours} hours successfully`);
                
                // Refresh current view
                const currentModule = sessionStorage.getItem('lastModule');
                if (currentModule === 'tasks') {
                    loadTasks(document.getElementById('main-content'));
                } else if (currentModule === 'timesheets') {
                    loadTimesheets(document.getElementById('main-content'));
                } else if (currentModule === 'dashboard') {
                    loadDashboard(document.getElementById('main-content'));
                }
            } catch (e) {
                showToast(e.message || 'Failed to log hours', 'error');
            }
        }

        async function createTask() {
            const title = prompt('Task title:');
            if(!title) return;
            try {
                await apiCall('tasks', {method: 'POST', title: title, assigned_to: currentUser.user_id, status: 'Backlog'});
                clearCache();
                showToast('Task created');
                loadTasks(document.getElementById('main-content'));
            } catch(e) {
                showToast(e.message || 'Failed to create task', 'error');
            }
        }

        async function loadPipeline(container) {
            container.innerHTML = `
                <div class="page-transition">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Hiring Pipeline</h2>
                            <p class="text-slate-500">Drag to move, drop on Hired to convert</p>
                        </div>
                        <button onclick="createCandidate()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Add Candidate
                        </button>
                    </div>
                    <div class="flex gap-6 overflow-x-auto kanban-scroll pb-4" id="pipeline-board">
                        ${renderPipelineColumn('Applied')}
                        ${renderPipelineColumn('Screening')}
                        ${renderPipelineColumn('Interview')}
                        ${renderPipelineColumn('Offer')}
                        ${renderPipelineColumn('Hired', true)}
                    </div>
                </div>
            `;
            
            try {
                const data = await apiCall('pipeline');
                const candidates = data.candidates || [];
                
                // Clear columns
                ['Applied', 'Screening', 'Interview', 'Offer', 'Hired'].forEach(stage => {
                    const col = document.getElementById(`pipe-${stage}`);
                    if(col) col.innerHTML = '';
                });
                
                candidates.forEach(c => {
                    const col = document.getElementById(`pipe-${c.stage}`);
                    if(col) col.innerHTML += renderCandidateCard(c);
                });
                
                ['Applied', 'Screening', 'Interview', 'Offer', 'Hired'].forEach(stage => {
                    new Sortable(document.getElementById(`pipe-${stage}`), {
                        group: 'pipeline', animation: 150, delay: 100, delayOnTouchOnly: true,
                        onEnd: async function(evt) {
                            const candidateId = evt.item.dataset.candidateId;
                            const newStage = evt.to.dataset.stage;
                            if(newStage === 'Hired' && !confirm('Hire this candidate? Creates employee record.')) {
                                evt.from.appendChild(evt.item);
                                return;
                            }
                            try {
                                const endpoint = newStage === 'Hired' ? 'pipeline/hire' : 'pipeline/move';
                                await apiCall(endpoint, {candidate_id: candidateId, to_stage: newStage});
                                showToast(newStage === 'Hired' ? 'Hired! Employee created.' : `Moved to ${newStage}`);
                                if(newStage === 'Hired') {
                                    evt.item.classList.add('bg-green-50', 'border-green-200');
                                    evt.item.innerHTML += '<div class="mt-2 text-xs text-green-600 font-medium">✓ Employee record created</div>';
                                }
                            } catch(e) {
                                evt.from.appendChild(evt.item);
                                showToast(e.message || 'Failed to move', 'error');
                            }
                        }
                    });
                });
            } catch(e) {
                container.innerHTML += `<div class="text-red-500 mt-4">${e.message || 'Failed to load pipeline'}</div>`;
            }
        }

        function renderPipelineColumn(stage, isFinal) {
            return `
                <div class="flex-shrink-0 w-80">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold ${isFinal ? 'text-green-700' : 'text-slate-700'}">${stage}</h3>
                    </div>
                    <div class="space-y-3 min-h-[200px] ${isFinal ? 'bg-green-50/50' : 'bg-slate-100/50'} rounded-xl p-2" id="pipe-${stage}" data-stage="${stage}"></div>
                </div>
            `;
        }

        function renderCandidateCard(c) {
            const isHired = c.stage === 'Hired';
            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border ${isHired ? 'border-green-200 bg-green-50' : 'border-slate-200'} card-hover cursor-move mb-2" data-candidate-id="${c.candidate_id}">
                    <div class="flex items-start justify-between mb-2">
                        <div class="w-10 h-10 ${isHired ? 'bg-green-500 text-white' : 'bg-blue-100 text-blue-600'} rounded-full flex items-center justify-center font-bold text-sm">
                            ${c.name.split(' ').map(n => n[0]).join('')}
                        </div>
                        ${c.rating ? `<span class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full">★ ${c.rating}</span>` : ''}
                    </div>
                    <h4 class="font-medium text-slate-900">${c.name}</h4>
                    <p class="text-sm text-slate-500 mb-1">${c.position || 'No position'}</p>
                    ${isHired ? '<div class="text-xs text-green-600 font-medium">✓ Converted to employee</div>' : ''}
                </div>
            `;
        }

        async function createCandidate() {
            const name = prompt('Candidate name:');
            if(!name) return;
            const email = prompt('Email:');
            if(!email) return;
            const position = prompt('Position:') || '';
            try {
                await apiCall('pipeline', {method: 'POST', name: name, email: email, position: position});
                showToast('Candidate added');
                loadPipeline(document.getElementById('main-content'));
            } catch(e) {
                showToast(e.message || 'Failed to add candidate', 'error');
            }
        }

        async function loadPayroll(container) {
            const isAdmin = currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
            const isManager = currentUser.role === 'Manager' || isAdmin;
            
            container.innerHTML = `
                <div class="page-transition">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Payroll</h2>
                            <p class="text-slate-500">Manage employee compensation</p>
                        </div>
                        <button onclick="createPayrollForm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Submit for Payment
                        </button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-4 py-3 font-medium text-slate-700">Employee</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Period</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Type</th>
                                        <th class="px-4 py-3 font-medium text-slate-700 text-right">Base</th>
                                        <th class="px-4 py-3 font-medium text-slate-700 text-right">Total</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Status</th>
                                        ${isManager ? '<th class="px-4 py-3 font-medium text-slate-700">Actions</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody id="payroll-table-body" class="divide-y divide-slate-100">
                                    <tr>
                                        <td colspan="${isManager ? 7 : 6}" class="px-4 py-8 text-center">
                                            <i class="fas fa-circle-notch fa-spin text-blue-600 mr-2"></i>Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                const params = isAdmin ? {} : {user_id: currentUser.user_id};
                const data = await apiCall('payroll', params);
                const payrolls = data.payroll || [];
                
                if (payrolls.length === 0) {
                    document.getElementById('payroll-table-body').innerHTML = 
                        `<tr><td colspan="${isManager ? 7 : 6}" class="px-4 py-8 text-center text-slate-400">No payroll records found</td></tr>`;
                    return;
                }
                
                const rows = payrolls.map(p => {
                    const statusColors = {
                        'Draft': 'bg-slate-100 text-slate-600', 
                        'Pending': 'bg-amber-100 text-amber-600', 
                        'Approved': 'bg-blue-100 text-blue-600', 
                        'Paid': 'bg-green-100 text-green-600'
                    };
                    let actions = '';
                    if (isManager) {
                        if (p.status === 'Draft' || p.status === 'Pending') {
                            actions = `<button onclick="approvePayroll(${p.payroll_id})" class="text-blue-600 hover:text-blue-800 font-medium">Approve</button>`;
                        } else if (p.status === 'Approved' && isAdmin) {
                            actions = `<button onclick="markPaid(${p.payroll_id})" class="text-green-600 hover:text-green-800 font-medium">Mark Paid</button>`;
                        } else {
                            actions = '-';
                        }
                    }
                    return `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 font-medium text-slate-900">Employee #${p.user_id}</td>
                            <td class="px-4 py-3 text-slate-600">${p.period_start} to ${p.period_end}</td>
                            <td class="px-4 py-3 text-slate-600">${getPayType(p)}</td>
                            <td class="px-4 py-3 text-right text-slate-900">$${p.base_amount.toFixed(2)}</td>
                            <td class="px-4 py-3 text-right font-bold text-slate-900">$${p.total_pay.toFixed(2)}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[p.status] || 'bg-slate-100 text-slate-600'}">${p.status}</span>
                            </td>
                            ${isManager ? `<td class="px-4 py-3">${actions}</td>` : ''}
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('payroll-table-body').innerHTML = rows;
            } catch (e) {
                document.getElementById('payroll-table-body').innerHTML = 
                    `<tr><td colspan="${isManager ? 7 : 6}" class="px-4 py-8 text-center text-red-500">${e.message || 'Failed to load payroll'}</td></tr>`;
            }
        }

        function getPayType(p) {
            if (p.hours_worked > 0) return 'Hourly';
            if (p.tasks_completed > 0) return 'Task';
            return 'Salary';
        }

        async function createPayrollForm() {
            const isAdmin = currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
            const isManager = currentUser.role === 'Manager' || isAdmin;
            let employeeOptions = '';
            
            if (isManager) {
                try {
                    let users = getCached('users');
                    if (!users) {
                        const userData = await apiCall('users');
                        users = userData.users || [];
                        setCached('users', users);
                    }
                    allUsers = users;
                    employeeOptions = users.map(u => 
                        `<option value="${u.user_id}" ${u.user_id === currentUser.user_id ? 'selected' : ''}>${u.name} (${u.email})</option>`
                    ).join('');
                } catch(e) {
                    console.error('Failed to load users:', e);
                }
            }
            
            const modal = document.createElement('div');
            modal.id = 'payroll-modal';
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-900 mb-4">Submit for Payment</h3>
                        <div class="space-y-4">
                            ${isManager ? `
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Employee</label>
                                <select id="pp-employee" class="w-full px-3 py-2 border border-slate-300 rounded-lg">${employeeOptions}</select>
                            </div>
                            ` : `<input type="hidden" id="pp-employee" value="${currentUser.user_id}">`}
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Period Start</label>
                                    <input type="date" id="pp-start" value="${getDefaultPeriodStart()}" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Period End</label>
                                    <input type="date" id="pp-end" value="${getDefaultPeriodEnd()}" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Pay Type</label>
                                <select id="pp-type" onchange="updatePayrollFormFields()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                    <option value="salary">Salary</option>
                                    <option value="hourly">Hourly</option>
                                    <option value="task_based">Task Based</option>
                                </select>
                            </div>
                            <div id="field-salary">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Base Salary ($)</label>
                                <input type="number" id="pp-salary" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div id="field-hourly" class="hidden space-y-3">
                                <div class="flex gap-2">
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Hourly Rate ($)</label>
                                        <input type="number" id="pp-rate" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Hours Worked</label>
                                        <input type="number" id="pp-hours" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                    </div>
                                </div>
                                <button onclick="loadDoneTasksForHourlySelection()" type="button" class="w-full py-2 bg-indigo-100 text-indigo-700 rounded-lg font-medium hover:bg-indigo-200 transition-colors">
                                    <i class="fas fa-list-check mr-2"></i>Select from Completed Tasks
                                </button>
                                <div id="hourly-tasks-list" class="mt-2"></div>
                                <div id="hourly-selected-total" class="text-sm text-slate-600"></div>
                            </div>
                            <div id="field-task" class="hidden space-y-3">
                                <div class="flex gap-2">
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Tasks Completed</label>
                                        <input type="number" id="pp-task-count" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Total Task Payments ($)</label>
                                        <input type="number" id="pp-task-pay" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                    </div>
                                </div>
                                <button onclick="loadDoneTasksForSelection()" type="button" class="w-full py-2 bg-indigo-100 text-indigo-700 rounded-lg font-medium hover:bg-indigo-200 transition-colors">
                                    <i class="fas fa-list-check mr-2"></i>Select from Completed Tasks
                                </button>
                                <div id="done-tasks-list" class="mt-2"></div>
                                <div id="selected-tasks-count" class="text-sm text-slate-600"></div>
                                <input type="hidden" id="selected-task-ids" value="[]">
                            </div>
                            ${isManager ? `
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Deductions ($)</label>
                                    <input type="number" id="pp-deductions" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Bonus ($)</label>
                                    <input type="number" id="pp-bonus" value="0" oninput="calculatePayrollTotal()" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                            </div>
                            ` : `
                            <input type="hidden" id="pp-deductions" value="0">
                            <input type="hidden" id="pp-bonus" value="0">
                            `}
                            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-slate-700">Total Pay:</span>
                                    <span id="pp-total" class="text-2xl font-bold text-green-600">$0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="submitPayrollForm()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">Submit Request</button>
                            <button onclick="closePayrollForm()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            calculatePayrollTotal();
        }
            
        function getDefaultPeriodStart() {
            const d = new Date();
            d.setDate(d.getDate() - 14);
            return d.toISOString().split('T')[0];
        }

        function getDefaultPeriodEnd() {
            const d = new Date();
            return d.toISOString().split('T')[0];
        }

        function updatePayrollFormFields() {
            const type = document.getElementById('pp-type').value;
            document.getElementById('field-salary').classList.toggle('hidden', type !== 'salary');
            document.getElementById('field-hourly').classList.toggle('hidden', type !== 'hourly');
            document.getElementById('field-task').classList.toggle('hidden', type !== 'task_based');
            calculatePayrollTotal();
        }

        function calculatePayrollTotal() {
            const type = document.getElementById('pp-type').value;
            let base = 0;
            if (type === 'salary') {
                base = parseFloat(document.getElementById('pp-salary').value) || 0;
            } else if (type === 'hourly') {
                const rate = parseFloat(document.getElementById('pp-rate').value) || 0;
                const hours = parseFloat(document.getElementById('pp-hours').value) || 0;
                base = rate * hours;
            } else if (type === 'task_based') {
                base = parseFloat(document.getElementById('pp-task-pay').value) || 0;
            }
            const deductions = parseFloat(document.getElementById('pp-deductions')?.value) || 0;
            const bonus = parseFloat(document.getElementById('pp-bonus')?.value) || 0;
            const total = base - deductions + bonus;
            document.getElementById('pp-total').textContent = '$' + total.toFixed(2);
        }

        async function loadDoneTasksForHourlySelection() {
            const employeeId = document.getElementById('pp-employee').value || currentUser.user_id;
            const periodStart = document.getElementById('pp-start').value;
            const periodEnd = document.getElementById('pp-end').value;
            const taskListDiv = document.getElementById('hourly-tasks-list');
            
            taskListDiv.innerHTML = '<p class="text-sm text-slate-500"><i class="fas fa-spinner fa-spin mr-1"></i>Loading...</p>';
            
            try {
                const data = await apiCall('payroll/calculate', {
                    user_id: employeeId,
                    period_start: periodStart,
                    period_end: periodEnd,
                    use_timesheets: 'true'
                });
                
                if (!data.task_details || data.task_details.length === 0) {
                    taskListDiv.innerHTML = '<p class="text-sm text-slate-500 italic">No hours logged in this period</p>';
                    return;
                }
                
                // Get task names from cache or fetch
                let tasks = getCached('tasks');
                if (!tasks) {
                    const tasksData = await apiCall('tasks');
                    tasks = tasksData.tasks || [];
                    setCached('tasks', tasks);
                }
                const tasksMap = {};
                tasks.forEach(t => tasksMap[t.task_id] = t.title);
                
                let html = '<div class="space-y-2 max-h-48 overflow-y-auto border border-slate-200 rounded-lg p-2">';
                
                data.task_details.forEach((task) => {
                    const taskName = tasksMap[task.task_id] || 'Task #' + task.task_id;
                    html += `
                        <div class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer" onclick="toggleHourlyTaskSelection(this, ${task.total_hours})">
                            <input type="checkbox" class="hourly-task-checkbox rounded text-blue-600" data-hours="${task.total_hours}" data-task-id="${task.task_id}" onchange="updateHourlySelectionTotal()">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-slate-900">${taskName}</p>
                                <p class="text-xs text-slate-500">${task.total_hours.toFixed(2)} hours</p>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                html += `<div class="mt-2 text-right"><span class="text-sm font-medium text-slate-700">Selected Hours: </span><span id="hourly-selected-total-display" class="text-lg font-bold text-green-600">0.00</span></div>`;
                html += `<button onclick="applyHourlyTaskSelection()" type="button" class="mt-2 w-full py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">Apply Selection</button>`;
                
                taskListDiv.innerHTML = html;
            } catch (e) {
                taskListDiv.innerHTML = '<p class="text-sm text-red-500">Failed to load tasks: ' + e.message + '</p>';
            }
        }

        function toggleHourlyTaskSelection(row, hours) {
            const checkbox = row.querySelector('.hourly-task-checkbox');
            checkbox.checked = !checkbox.checked;
            updateHourlySelectionTotal();
        }

        function updateHourlySelectionTotal() {
            const checkboxes = document.querySelectorAll('.hourly-task-checkbox:checked');
            let totalHours = 0;
            checkboxes.forEach(cb => {
                totalHours += parseFloat(cb.dataset.hours) || 0;
            });
            const display = document.getElementById('hourly-selected-total-display');
            if (display) display.textContent = totalHours.toFixed(2);
        }

        function applyHourlyTaskSelection() {
            const checkboxes = document.querySelectorAll('.hourly-task-checkbox:checked');
            let totalHours = 0;
            
            checkboxes.forEach(cb => {
                totalHours += parseFloat(cb.dataset.hours) || 0;
            });
            
            document.getElementById('pp-hours').value = totalHours.toFixed(2);
            calculatePayrollTotal();
            
            document.getElementById('hourly-tasks-list').innerHTML = '';
            showToast(`Applied ${totalHours.toFixed(2)} hours from selected tasks`);
        }

        async function loadDoneTasksForSelection() {
            const employeeId = document.getElementById('pp-employee').value || currentUser.user_id;
            const taskListDiv = document.getElementById('done-tasks-list');
            
            taskListDiv.innerHTML = '<p class="text-sm text-slate-500"><i class="fas fa-spinner fa-spin mr-1"></i>Loading...</p>';
            
            try {
                let tasks = getCached('tasks');
                if (!tasks) {
                    const data = await apiCall('tasks', {assignee: employeeId, status: 'Done'});
                    tasks = data.tasks || [];
                } else {
                    tasks = tasks.filter(t => t.assigned_to == employeeId && t.status === 'Done');
                }
                
                const unpaidTasks = tasks.filter(t => !t.paid);
                
                if (unpaidTasks.length === 0) {
                    taskListDiv.innerHTML = '<p class="text-sm text-slate-500 italic">No unpaid completed tasks found</p>';
                    return;
                }
                
                let html = '<div class="space-y-2 max-h-40 overflow-y-auto border border-slate-200 rounded-lg p-2">';
                
                unpaidTasks.forEach((task) => {
                    const payAmount = parseFloat(task.pay_per_task) || 0;
                    html += `
                        <div class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer" onclick="toggleTaskSelection(this, ${payAmount})">
                            <input type="checkbox" class="task-select-checkbox rounded text-blue-600" data-pay="${payAmount}" data-task-id="${task.task_id}" onchange="updateSelectedTasksTotal()">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-slate-900">${task.title}</p>
                                <p class="text-xs text-slate-500">$${payAmount.toFixed(2)}</p>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                html += `<div class="mt-2 text-right"><span class="text-sm font-medium text-slate-700">Selected Total: </span><span id="selected-tasks-total" class="text-lg font-bold text-green-600">$0.00</span></div>`;
                html += `<button onclick="applySelectedTasks()" type="button" class="mt-2 w-full py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">Apply Selected Tasks</button>`;
                
                taskListDiv.innerHTML = html;
            } catch (e) {
                taskListDiv.innerHTML = '<p class="text-sm text-red-500">Failed to load tasks</p>';
            }
        }

        function toggleTaskSelection(row, payAmount) {
            const checkbox = row.querySelector('.task-select-checkbox');
            checkbox.checked = !checkbox.checked;
            updateSelectedTasksTotal();
        }

        function updateSelectedTasksTotal() {
            const checkboxes = document.querySelectorAll('.task-select-checkbox:checked');
            let total = 0;
            let count = 0;
            checkboxes.forEach(cb => {
                total += parseFloat(cb.dataset.pay) || 0;
                count++;
            });
            document.getElementById('selected-tasks-total').textContent = '$' + total.toFixed(2);
            const countEl = document.getElementById('selected-tasks-count');
            if (countEl) countEl.textContent = count + ' tasks selected';
        }

        function applySelectedTasks() {
            const checkboxes = document.querySelectorAll('.task-select-checkbox:checked');
            let totalPay = 0;
            let count = 0;
            const selectedTaskIds = [];
            
            checkboxes.forEach(cb => {
                totalPay += parseFloat(cb.dataset.pay) || 0;
                count++;
                selectedTaskIds.push(cb.dataset.taskId);
            });
            
            document.getElementById('pp-task-count').value = count;
            document.getElementById('pp-task-pay').value = totalPay.toFixed(2);
            document.getElementById('selected-task-ids').value = JSON.stringify(selectedTaskIds);
            calculatePayrollTotal();
            
            document.getElementById('done-tasks-list').innerHTML = '';
            showToast(`Applied ${count} tasks, $${totalPay.toFixed(2)}`);
        }

        function closePayrollForm() {
            document.getElementById('payroll-modal')?.remove();
        }

        async function submitPayrollForm() {
            const employeeId = document.getElementById('pp-employee').value || currentUser.user_id;
            const type = document.getElementById('pp-type').value;
            let baseAmount = 0, hoursWorked = 0, tasksCompleted = 0, taskPayments = 0;
            
            if (type === 'salary') {
                baseAmount = parseFloat(document.getElementById('pp-salary').value) || 0;
            } else if (type === 'hourly') {
                const rate = parseFloat(document.getElementById('pp-rate').value) || 0;
                hoursWorked = parseFloat(document.getElementById('pp-hours').value) || 0;
                baseAmount = rate * hoursWorked;
            } else if (type === 'task_based') {
                tasksCompleted = parseFloat(document.getElementById('pp-task-count').value) || 0;
                taskPayments = parseFloat(document.getElementById('pp-task-pay').value) || 0;
                baseAmount = taskPayments;
            }
            
            const deductions = parseFloat(document.getElementById('pp-deductions')?.value) || 0;
            const bonus = parseFloat(document.getElementById('pp-bonus')?.value) || 0;
            const totalPay = baseAmount - deductions + bonus;
            
            const selectedTaskIds = document.getElementById('selected-task-ids')?.value || '[]';
            
            const payload = {
                method: 'POST',
                user_id: employeeId,
                period_start: document.getElementById('pp-start').value,
                period_end: document.getElementById('pp-end').value,
                base_amount: baseAmount,
                hours_worked: hoursWorked,
                tasks_completed: tasksCompleted,
                task_payments: taskPayments,
                deductions: deductions,
                bonus: bonus,
                total_pay: totalPay,
                task_ids: selectedTaskIds
            };
            
            try {
                await apiCall('payroll', payload);
                closePayrollForm();
                clearCache();
                showToast('Payment request submitted');
                showModule('payroll');
            } catch (e) {
                showToast(e.message || 'Failed to submit request', 'error');
            }
        }

        async function approvePayroll(payrollId) {
            try {
                await apiCall('payroll/approve', {payroll_id: payrollId});
                clearCache();
                showToast('Payment approved');
                showModule('payroll');
            } catch (e) {
                showToast(e.message || 'Approval failed', 'error');
            }
        }

        async function markPaid(payrollId) {
            try {
                await apiCall('payroll/pay', {payroll_id: payrollId});
                clearCache();
                showToast('Payment marked as paid');
                showModule('payroll');
            } catch (e) {
                showToast(e.message || 'Failed to mark paid', 'error');
            }
        }

        async function loadTimesheets(container) {
            const isManager = currentUser.role === 'Manager' || currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
            
            container.innerHTML = `
                <div class="page-transition">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Timesheets</h2>
                            <p class="text-slate-500">Log and view work hours</p>
                        </div>
                        <button onclick="openLogHoursModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Log Hours
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                        <div class="p-4 border-b border-slate-200">
                            <div class="flex flex-wrap gap-4 items-end">
                                ${isManager ? `
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">Employee</label>
                                    <select id="ts-filter-user" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="">All Employees</option>
                                    </select>
                                </div>
                                ` : ''}
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">From</label>
                                    <input type="date" id="ts-filter-from" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">To</label>
                                    <input type="date" id="ts-filter-to" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                </div>
                                <button onclick="loadTimesheetData()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200">
                                    <i class="fas fa-filter mr-1"></i>Filter
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-4 py-3 font-medium text-slate-700">Date</th>
                                        ${isManager ? '<th class="px-4 py-3 font-medium text-slate-700">Employee</th>' : ''}
                                        <th class="px-4 py-3 font-medium text-slate-700">Task</th>
                                        <th class="px-4 py-3 font-medium text-slate-700 text-right">Hours</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="timesheet-table-body" class="divide-y divide-slate-100">
                                    <tr>
                                        <td colspan="${isManager ? 5 : 4}" class="px-4 py-8 text-center">
                                            <i class="fas fa-circle-notch fa-spin text-blue-600 mr-2"></i>Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="timesheet-summary" class="p-4 bg-slate-50 border-t border-slate-200">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-slate-700">Total Hours:</span>
                                <span id="ts-total-hours" class="text-xl font-bold text-blue-600">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('ts-filter-from').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('ts-filter-to').value = today.toISOString().split('T')[0];
            
            if (isManager) {
                try {
                    let users = getCached('users');
                    if (!users) {
                        const userData = await apiCall('users');
                        users = userData.users || [];
                        setCached('users', users);
                    }
                    const userSelect = document.getElementById('ts-filter-user');
                    users.forEach(u => {
                        if (u.active !== false) {
                            const option = document.createElement('option');
                            option.value = u.user_id;
                            option.textContent = u.name;
                            userSelect.appendChild(option);
                        }
                    });
                } catch (e) {
                    console.error('Failed to load users:', e);
                }
            }
            
            await loadTimesheetData();
        }

        async function loadTimesheetData() {
            const isManager = currentUser.role === 'Manager' || currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
            const userId = isManager ? document.getElementById('ts-filter-user').value : currentUser.user_id;
            const dateFrom = document.getElementById('ts-filter-from').value;
            const dateTo = document.getElementById('ts-filter-to').value;
            
            try {
                const params = {
                    date_from: dateFrom,
                    date_to: dateTo
                };
                if (userId) params.user_id = userId;
                
                const data = await apiCall('timesheets', params);
                const entries = data.timesheets || [];
                
                // Get task names from cache
                let tasks = getCached('tasks');
                if (!tasks) {
                    const tasksData = await apiCall('tasks');
                    tasks = tasksData.tasks || [];
                    setCached('tasks', tasks);
                }
                const tasksMap = {};
                tasks.forEach(t => tasksMap[t.task_id] = t.title);
                
                if (entries.length === 0) {
                    document.getElementById('timesheet-table-body').innerHTML = 
                        `<tr><td colspan="${isManager ? 5 : 4}" class="px-4 py-8 text-center text-slate-400">No timesheet entries found</td></tr>`;
                    document.getElementById('ts-total-hours').textContent = '0';
                    return;
                }
                
                let totalHours = 0;
                const rows = entries.map(e => {
                    totalHours += e.hours;
                    return `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 text-slate-900">${e.date}</td>
                            ${isManager ? `<td class="px-4 py-3 text-slate-600">User #${e.user_id}</td>` : ''}
                            <td class="px-4 py-3 text-slate-900 font-medium">${tasksMap[e.task_id] || 'Task #' + e.task_id}</td>
                            <td class="px-4 py-3 text-right font-bold text-blue-600">${e.hours.toFixed(2)}</td>
                            <td class="px-4 py-3 text-slate-600 text-sm">${e.notes || '-'}</td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('timesheet-table-body').innerHTML = rows;
                document.getElementById('ts-total-hours').textContent = totalHours.toFixed(2);
            } catch (e) {
                document.getElementById('timesheet-table-body').innerHTML = 
                    `<tr><td colspan="${isManager ? 5 : 4}" class="px-4 py-8 text-center text-red-500">${e.message || 'Failed to load timesheets'}</td></tr>`;
            }
        }

        async function openLogHoursModal() {
            try {
                let tasks = getCached('tasks');
                if (!tasks) {
                    const tasksData = await apiCall('tasks', {assignee: currentUser.user_id});
                    tasks = tasksData.tasks || [];
                } else {
                    tasks = tasks.filter(t => t.assigned_to == currentUser.user_id);
                }
                
                const modal = document.createElement('div');
                modal.id = 'log-hours-modal';
                modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-slate-900 mb-4">Log Work Hours</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Task</label>
                                    <select id="lh-task" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                        <option value="">Select a task...</option>
                                        ${tasks.map(t => `<option value="${t.task_id}">${t.title} (${t.status})</option>`).join('')}
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
                                        <input type="date" id="lh-date" value="${new Date().toISOString().split('T')[0]}" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Hours</label>
                                        <input type="number" id="lh-hours" step="0.25" min="0.25" max="24" placeholder="0.00" class="w-full px-3 py-2 border border-slate-300 rounded-lg" autofocus>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Notes (Optional)</label>
                                    <textarea id="lh-notes" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg" placeholder="What did you work on?"></textarea>
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="submitLogHours()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">Log Hours</button>
                                <button onclick="closeLogHoursModal()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('lh-hours').focus();
            } catch (e) {
                showToast('Failed to load tasks', 'error');
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('hidden');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 shadow-lg transform transition-all duration-300 translate-y-0 ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
            toast.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2"></i>${message}`;
            document.body.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.style.transform = 'translateY(0)';
                toast.style.opacity = '1';
            });
            
            setTimeout(() => {
                toast.style.transform = 'translateY(100%)';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

         // ==================== FINANCIALS FUNCTIONS ====================

        async function loadFinancials(container) {
            const isAdmin = currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin';
            
            container.innerHTML = `
                <div class="page-transition">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900">Financials</h2>
                            <p class="text-slate-500">Track income, expenses, and cash flow</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="createInvoiceForm()" class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                                <i class="fas fa-file-invoice-dollar mr-2"></i>New Invoice
                            </button>
                            <button onclick="createBillForm()" class="px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700">
                                <i class="fas fa-file-invoice mr-2"></i>New Bill
                            </button>
                            <button onclick="createTransactionForm()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>Transaction
                            </button>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="financials-summary">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div class="animate-pulse h-16 bg-slate-200 rounded"></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div class="animate-pulse h-16 bg-slate-200 rounded"></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div class="animate-pulse h-16 bg-slate-200 rounded"></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div class="animate-pulse h-16 bg-slate-200 rounded"></div>
                        </div>
                    </div>
                    
                    <!-- Transactions Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-200 flex flex-wrap gap-4 items-center">
                            <h3 class="font-semibold text-slate-900">Transactions</h3>
                            <div class="flex gap-2 ml-auto">
                                <select id="fin-type-filter" onchange="loadFinancialsData()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm">
                                    <option value="">All Types</option>
                                    <option value="income">Income</option>
                                    <option value="expense">Expenses</option>
                                </select>
                                <input type="date" id="fin-date-from" onchange="loadFinancialsData()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm">
                                <input type="date" id="fin-date-to" onchange="loadFinancialsData()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm">
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-4 py-3 font-medium text-slate-700">Date</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Type</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Category</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Description</th>
                                        <th class="px-4 py-3 font-medium text-slate-700 text-right">Amount</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Status</th>
                                        <th class="px-4 py-3 font-medium text-slate-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="financials-table-body" class="divide-y divide-slate-100">
                                    <tr><td colspan="7" class="px-4 py-8 text-center text-slate-400">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Set default dates (current month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('fin-date-from').value = firstDay.toISOString().split('T')[0];
            document.getElementById('fin-date-to').value = today.toISOString().split('T')[0];
            
            await loadFinancialsData();
        }

        async function loadFinancialsData() {
            try {
                const typeFilter = document.getElementById('fin-type-filter').value;
                const dateFrom = document.getElementById('fin-date-from').value;
                const dateTo = document.getElementById('fin-date-to').value;
                
                const params = {};
                if (typeFilter) params.type = typeFilter;
                if (dateFrom) params.date_from = dateFrom;
                if (dateTo) params.date_to = dateTo;
                
                const [data, summaryData] = await Promise.all([
                    apiCall('financials', params),
                    apiCall('financials/summary', {date_from: dateFrom, date_to: dateTo})
                ]);
                
                const transactions = data.transactions || [];
                const summary = summaryData.summary || {};
                
                // Update summary cards
                document.getElementById('financials-summary').innerHTML = `
                    <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                        <p class="text-sm text-green-700 font-medium">Total Income</p>
                        <p class="text-2xl font-bold text-green-700">$${(summary.total_income || 0).toFixed(2)}</p>
                        ${(summary.pending_receivables || 0) > 0 ? `<p class="text-xs text-green-600 mt-1">+$${(summary.pending_receivables || 0).toFixed(2)} pending</p>` : ''}
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-200">
                        <p class="text-sm text-red-700 font-medium">Total Expenses</p>
                        <p class="text-2xl font-bold text-red-700">$${(summary.total_expenses || 0).toFixed(2)}</p>
                        ${(summary.pending_payables || 0) > 0 ? `<p class="text-xs text-red-600 mt-1">+$${(summary.pending_payables || 0).toFixed(2)} pending</p>` : ''}
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                        <p class="text-sm text-blue-700 font-medium">Net Profit</p>
                        <p class="text-2xl font-bold text-blue-700">$${(summary.net_profit || 0).toFixed(2)}</p>
                        <p class="text-xs text-blue-600 mt-1">Cash flow: $${(summary.cash_flow || 0).toFixed(2)}</p>
                    </div>
                    <div class="bg-amber-50 p-4 rounded-xl border border-amber-200">
                        <p class="text-sm text-amber-700 font-medium">Pending</p>
                        <p class="text-lg font-bold text-amber-700">+$${(summary.pending_receivables || 0).toFixed(2)}</p>
                        <p class="text-lg font-bold text-amber-700">-$${(summary.pending_payables || 0).toFixed(2)}</p>
                    </div>
                `;
                
                // Update table
                if (transactions.length === 0) {
                    document.getElementById('financials-table-body').innerHTML = 
                        '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-400">No transactions found</td></tr>';
                    return;
                }
                
                const rows = transactions.map(t => {
                    const typeColors = {
                        'income': 'text-green-600 bg-green-50',
                        'expense': 'text-red-600 bg-red-50',
                        'transfer': 'text-blue-600 bg-blue-50'
                    };
                    const statusColors = {
                        'paid': 'bg-green-100 text-green-700',
                        'pending': 'bg-amber-100 text-amber-700',
                        'sent': 'bg-blue-100 text-blue-700',
                        'overdue': 'bg-red-100 text-red-700'
                    };
                    
                    let actions = '';
                    if (t.status === 'pending') {
                        if (t.type === 'expense' && t.subtype === 'bill') {
                            actions = `<button onclick="payBill(${t.transaction_id})" class="text-green-600 hover:text-green-800 font-medium">Pay</button>`;
                        } else if (t.type === 'income' && t.subtype === 'invoice') {
                            actions = `<button onclick="sendInvoice(${t.transaction_id})" class="text-blue-600 hover:text-blue-800 font-medium">Send</button>`;
                        }
                    }
                    
                    return `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-3 text-slate-900">${t.date}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${typeColors[t.type] || 'bg-slate-100 text-slate-600'}">
                                    ${t.subtype || t.type}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-slate-600 capitalize">${t.category}</td>
                            <td class="px-4 py-3 text-slate-900">${t.description}</td>
                            <td class="px-4 py-3 text-right font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                                ${t.type === 'income' ? '+' : '-'}$${(t.amount || 0).toFixed(2)}
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[t.status] || 'bg-slate-100 text-slate-600'}">
                                    ${t.status}
                                </span>
                            </td>
                            <td class="px-4 py-3">${actions}</td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('financials-table-body').innerHTML = rows;
                
            } catch (e) {
                document.getElementById('financials-table-body').innerHTML = 
                    `<tr><td colspan="7" class="px-4 py-8 text-center text-red-500">${e.message || 'Failed to load financials'}</td></tr>`;
            }
        }

        function createTransactionForm() {
            const modal = document.createElement('div');
            modal.id = 'transaction-modal';
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-900 mb-4">New Transaction</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Type</label>
                                <select id="trans-type" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                    <option value="expense">Expense</option>
                                    <option value="income">Income</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                                <input type="text" id="trans-category" placeholder="e.g., supplies, services" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Amount ($)</label>
                                    <input type="number" id="trans-amount" step="0.01" min="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
                                    <input type="date" id="trans-date" value="${new Date().toISOString().split('T')[0]}" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                                <textarea id="trans-description" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="submitTransaction()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">Save</button>
                            <button onclick="closeTransactionModal()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeTransactionModal() {
            document.getElementById('transaction-modal')?.remove();
        }

        async function submitTransaction() {
            const type = document.getElementById('trans-type').value;
            const category = document.getElementById('trans-category').value;
            const amount = parseFloat(document.getElementById('trans-amount').value);
            const date = document.getElementById('trans-date').value;
            const description = document.getElementById('trans-description').value;
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            try {
                await apiCall('financials', {
                    method: 'POST',
                    type: type,
                    category: category,
                    amount: amount,
                    date: date,
                    description: description,
                    status: 'paid'
                });
                
                closeTransactionModal();
                clearCache();
                showToast('Transaction saved');
                loadFinancialsData();
            } catch (e) {
                showToast(e.message || 'Failed to save transaction', 'error');
            }
        }

        function createInvoiceForm() {
            const modal = document.createElement('div');
            modal.id = 'invoice-modal';
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-900 mb-4">New Invoice</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Client</label>
                                <input type="text" id="inv-client" placeholder="Client name or ID" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Amount ($)</label>
                                    <input type="number" id="inv-amount" step="0.01" min="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Due Date</label>
                                    <input type="date" id="inv-due" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                                <textarea id="inv-description" rows="2" placeholder="Invoice for..." class="w-full px-3 py-2 border border-slate-300 rounded-lg"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="submitInvoice()" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700">Create Invoice</button>
                            <button onclick="document.getElementById('invoice-modal').remove()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitInvoice() {
            const clientId = document.getElementById('inv-client').value;
            const amount = parseFloat(document.getElementById('inv-amount').value);
            const dueDate = document.getElementById('inv-due').value;
            const description = document.getElementById('inv-description').value;
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            try {
                await apiCall('invoices', {
                    method: 'POST',
                    client_id: clientId,
                    amount: amount,
                    due_date: dueDate,
                    description: description
                });
                
                document.getElementById('invoice-modal').remove();
                clearCache();
                showToast('Invoice created');
                loadFinancialsData();
            } catch (e) {
                showToast(e.message || 'Failed to create invoice', 'error');
            }
        }

        function createBillForm() {
            const modal = document.createElement('div');
            modal.id = 'bill-modal';
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-900 mb-4">New Bill</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Vendor</label>
                                <input type="text" id="bill-vendor" placeholder="Vendor name" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Amount ($)</label>
                                    <input type="number" id="bill-amount" step="0.01" min="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Due Date</label>
                                    <input type="date" id="bill-due" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                                <textarea id="bill-description" rows="2" placeholder="Bill for..." class="w-full px-3 py-2 border border-slate-300 rounded-lg"></textarea>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="submitBill()" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-medium hover:bg-red-700">Create Bill</button>
                            <button onclick="document.getElementById('bill-modal').remove()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitBill() {
            const vendorId = document.getElementById('bill-vendor').value;
            const amount = parseFloat(document.getElementById('bill-amount').value);
            const dueDate = document.getElementById('bill-due').value;
            const description = document.getElementById('bill-description').value;
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            try {
                await apiCall('bills', {
                    method: 'POST',
                    vendor_id: vendorId,
                    amount: amount,
                    due_date: dueDate,
                    description: description
                });
                
                document.getElementById('bill-modal').remove();
                clearCache();
                showToast('Bill created');
                loadFinancialsData();
            } catch (e) {
                showToast(e.message || 'Failed to create bill', 'error');
            }
        }

        async function payBill(billId) {
            try {
                await apiCall('bills/pay', {bill_id: billId});
                clearCache();
                showToast('Bill paid');
                loadFinancialsData();
            } catch (e) {
                showToast(e.message || 'Failed to pay bill', 'error');
            }
        }

        async function sendInvoice(invoiceId) {
            try {
                await apiCall('invoices/send', {invoice_id: invoiceId});
                clearCache();
                showToast('Invoice sent');
                loadFinancialsData();
            } catch (e) {
                showToast(e.message || 'Failed to send invoice', 'error');
            }
        }
        
        // Initialize on load
        window.onload = () => {
            if(currentToken) {
                const savedUser = localStorage.getItem('workvolt_user');
                if(savedUser) {
                    try {
                        currentUser = JSON.parse(savedUser);
                        // Validate token silently
                        apiCall('users/me').then(() => {
                            showApp();
                        }).catch(err => {
                            // Token invalid, clear and stay on login
                            localStorage.removeItem('workvolt_token');
                            localStorage.removeItem('workvolt_user');
                            currentToken = null;
                            currentUser = null;
                        });
                    } catch(e) {
                        localStorage.removeItem('workvolt_token');
                        localStorage.removeItem('workvolt_user');
                    }
                }
            }
        };
    </script>
</body>
</html>

